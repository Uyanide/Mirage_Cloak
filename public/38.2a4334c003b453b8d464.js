/*! For license information please see 38.2a4334c003b453b8d464.js.LICENSE.txt */
"use strict";(self.webpackChunkmirage_cloak=self.webpackChunkmirage_cloak||[]).push([[38],{38:(e,t,r)=>{r.r(t),r.d(t,{CloakEncoder:()=>x});var n=r(490),i=r(23),a=r(287).hp;function o(e){Math.round;var t,r,n,i,o,s=Math.floor,c=new Array(64),_=new Array(64),h=new Array(64),u=new Array(64),f=new Array(65535),l=new Array(65535),d=new Array(64),g=new Array(64),v=[],p=0,y=7,m=new Array(64),b=new Array(64),w=new Array(64),C=new Array(256),I=new Array(2048),x=[0,1,5,6,14,15,27,28,2,4,7,13,16,26,29,42,3,8,12,17,25,30,41,43,9,11,18,24,31,40,44,53,10,19,23,32,39,45,52,54,20,22,33,38,46,51,55,60,21,34,37,47,50,56,59,61,35,36,48,49,57,58,62,63],A=[0,0,1,5,1,1,1,1,1,1,0,0,0,0,0,0,0],D=[0,1,2,3,4,5,6,7,8,9,10,11],M=[0,0,2,1,3,3,2,4,3,5,5,4,4,0,0,1,125],E=[1,2,3,0,4,17,5,18,33,49,65,6,19,81,97,7,34,113,20,50,129,145,161,8,35,66,177,193,21,82,209,240,36,51,98,114,130,9,10,22,23,24,25,26,37,38,39,40,41,42,52,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,225,226,227,228,229,230,231,232,233,234,241,242,243,244,245,246,247,248,249,250],L=[0,0,3,1,1,1,1,1,1,1,1,1,0,0,0,0,0],S=[0,1,2,3,4,5,6,7,8,9,10,11],k=[0,0,2,1,2,4,4,3,4,7,5,4,4,0,1,2,119],B=[0,1,2,3,17,4,5,33,49,6,18,65,81,7,97,113,19,34,50,129,8,20,66,145,161,177,193,9,35,51,82,240,21,98,114,209,10,22,36,52,225,37,241,23,24,25,26,38,39,40,41,42,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,130,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,226,227,228,229,230,231,232,233,234,242,243,244,245,246,247,248,249,250];function j(e,t){for(var r=0,n=0,i=new Array,a=1;a<=16;a++){for(var o=1;o<=e[a];o++)i[t[n]]=[],i[t[n]][0]=r,i[t[n]][1]=a,n++,r++;r*=2}return i}function z(e){for(var t=e[0],r=e[1]-1;r>=0;)t&1<<r&&(p|=1<<y),r--,--y<0&&(255==p?(O(255),O(0)):O(p),y=7,p=0)}function O(e){v.push(e)}function P(e){O(e>>8&255),O(255&e)}function R(e,t,r,n,i){for(var a,o=i[0],s=i[240],c=function(e,t){var r,n,i,a,o,s,c,_,h,u,f=0;for(h=0;h<8;++h){r=e[f],n=e[f+1],i=e[f+2],a=e[f+3],o=e[f+4],s=e[f+5],c=e[f+6];var l=r+(_=e[f+7]),g=r-_,v=n+c,p=n-c,y=i+s,m=i-s,b=a+o,w=a-o,C=l+b,I=l-b,x=v+y,A=v-y;e[f]=C+x,e[f+4]=C-x;var D=.707106781*(A+I);e[f+2]=I+D,e[f+6]=I-D;var M=.382683433*((C=w+m)-(A=p+g)),E=.5411961*C+M,L=1.306562965*A+M,S=.707106781*(x=m+p),k=g+S,B=g-S;e[f+5]=B+E,e[f+3]=B-E,e[f+1]=k+L,e[f+7]=k-L,f+=8}for(f=0,h=0;h<8;++h){r=e[f],n=e[f+8],i=e[f+16],a=e[f+24],o=e[f+32],s=e[f+40],c=e[f+48];var j=r+(_=e[f+56]),z=r-_,O=n+c,P=n-c,R=i+s,F=i-s,T=a+o,U=a-o,q=j+T,G=j-T,N=O+R,H=O-R;e[f]=q+N,e[f+32]=q-N;var Q=.707106781*(H+G);e[f+16]=G+Q,e[f+48]=G-Q;var W=.382683433*((q=U+F)-(H=P+z)),J=.5411961*q+W,V=1.306562965*H+W,Y=.707106781*(N=F+P),$=z+Y,K=z-Y;e[f+40]=K+J,e[f+24]=K-J,e[f+8]=$+V,e[f+56]=$-V,f++}for(h=0;h<64;++h)u=e[h]*t[h],d[h]=u>0?u+.5|0:u-.5|0;return d}(e,t),_=0;_<64;++_)g[x[_]]=c[_];var h=g[0]-r;r=g[0],0==h?z(n[0]):(z(n[l[a=32767+h]]),z(f[a]));for(var u=63;u>0&&0==g[u];u--);if(0==u)return z(o),r;for(var v,p=1;p<=u;){for(var y=p;0==g[p]&&p<=u;++p);var m=p-y;if(m>=16){v=m>>4;for(var b=1;b<=v;++b)z(s);m&=15}a=32767+g[p],z(i[(m<<4)+l[a]]),z(f[a]),p++}return 63!=u&&z(o),r}function F(e){if(e<=0&&(e=1),e>100&&(e=100),o!=e){(function(e){for(var t=[16,11,10,16,24,40,51,61,12,12,14,19,26,58,60,55,14,13,16,24,40,57,69,56,14,17,22,29,51,87,80,62,18,22,37,56,68,109,103,77,24,35,55,64,81,104,113,92,49,64,78,87,103,121,120,101,72,92,95,98,112,100,103,99],r=0;r<64;r++){var n=s((t[r]*e+50)/100);n<1?n=1:n>255&&(n=255),c[x[r]]=n}for(var i=[17,18,24,47,99,99,99,99,18,21,26,66,99,99,99,99,24,26,56,99,99,99,99,99,47,66,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99],a=0;a<64;a++){var o=s((i[a]*e+50)/100);o<1?o=1:o>255&&(o=255),_[x[a]]=o}for(var f=[1,1.387039845,1.306562965,1.175875602,1,.785694958,.5411961,.275899379],l=0,d=0;d<8;d++)for(var g=0;g<8;g++)h[l]=1/(c[x[l]]*f[d]*f[g]*8),u[l]=1/(_[x[l]]*f[d]*f[g]*8),l++})(e<50?Math.floor(5e3/e):Math.floor(200-2*e)),o=e}}this.encode=function(e,o){var s;(new Date).getTime();o&&F(o),v=new Array,p=0,y=7,P(65496),P(65504),P(16),O(74),O(70),O(73),O(70),O(0),O(1),O(1),O(0),P(1),P(1),O(0),O(0),void 0!==(s=e.comments)&&s.constructor===Array&&s.forEach((function(e){if("string"==typeof e){P(65534);var t,r=e.length;for(P(r+2),t=0;t<r;t++)O(e.charCodeAt(t))}})),function(e){if(e){P(65505),69===e[0]&&120===e[1]&&105===e[2]&&102===e[3]?P(e.length+2):(P(e.length+5+2),O(69),O(120),O(105),O(102),O(0));for(var t=0;t<e.length;t++)O(e[t])}}(e.exifBuffer),function(){P(65499),P(132),O(0);for(var e=0;e<64;e++)O(c[e]);O(1);for(var t=0;t<64;t++)O(_[t])}(),function(e,t){P(65472),P(17),O(8),P(t),P(e),O(3),O(1),O(17),O(0),O(2),O(17),O(1),O(3),O(17),O(1)}(e.width,e.height),function(){P(65476),P(418),O(0);for(var e=0;e<16;e++)O(A[e+1]);for(var t=0;t<=11;t++)O(D[t]);O(16);for(var r=0;r<16;r++)O(M[r+1]);for(var n=0;n<=161;n++)O(E[n]);O(1);for(var i=0;i<16;i++)O(L[i+1]);for(var a=0;a<=11;a++)O(S[a]);O(17);for(var o=0;o<16;o++)O(k[o+1]);for(var s=0;s<=161;s++)O(B[s])}(),P(65498),P(12),O(3),O(1),O(0),O(2),O(17),O(3),O(17),O(0),O(63),O(0);var f=0,l=0,d=0;p=0,y=7,this.encode.displayName="_encode_";for(var g,C,x,j,T,U,q,G,N,H=e.data,Q=e.width,W=e.height,J=4*Q,V=0;V<W;){for(g=0;g<J;){for(U=T=J*V+g,q=-1,G=0,N=0;N<64;N++)U=T+(G=N>>3)*J+(q=4*(7&N)),V+G>=W&&(U-=J*(V+1+G-W)),g+q>=J&&(U-=g+q-J+4),C=H[U++],x=H[U++],j=H[U++],m[N]=(I[C]+I[x+256|0]+I[j+512|0]>>16)-128,b[N]=(I[C+768|0]+I[x+1024|0]+I[j+1280|0]>>16)-128,w[N]=(I[C+1280|0]+I[x+1536|0]+I[j+1792|0]>>16)-128;f=R(m,h,f,t,n),l=R(b,u,l,r,i),d=R(w,u,d,r,i),g+=32}V+=8}if(y>=0){var Y=[];Y[1]=y+1,Y[0]=(1<<y+1)-1,z(Y)}return P(65497),a.from(v)},function(){(new Date).getTime();e||(e=50),function(){for(var e=String.fromCharCode,t=0;t<256;t++)C[t]=e(t)}(),t=j(A,D),r=j(L,S),n=j(M,E),i=j(k,B),function(){for(var e=1,t=2,r=1;r<=15;r++){for(var n=e;n<t;n++)l[32767+n]=r,f[32767+n]=[],f[32767+n][1]=r,f[32767+n][0]=n;for(var i=-(t-1);i<=-e;i++)l[32767+i]=r,f[32767+i]=[],f[32767+i][1]=r,f[32767+i][0]=t-1+i;e<<=1,t<<=1}}(),function(){for(var e=0;e<256;e++)I[e]=19595*e,I[e+256|0]=38470*e,I[e+512|0]=7471*e+32768,I[e+768|0]=-11059*e,I[e+1024|0]=-21709*e,I[e+1280|0]=32768*e+8421375,I[e+1536|0]=-27439*e,I[e+1792|0]=-5329*e}(),F(e),(new Date).getTime()}()}function s(e){return s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s(e)}function c(e){return function(e){if(Array.isArray(e))return _(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return _(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function h(){return h="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=function(e,t){for(;!{}.hasOwnProperty.call(e,t)&&null!==(e=m(e)););return e}(e,t);if(n){var i=Object.getOwnPropertyDescriptor(n,t);return i.get?i.get.call(arguments.length<3?e:r):i.value}},h.apply(null,arguments)}function u(){u=function(){return t};var e,t={},r=Object.prototype,n=r.hasOwnProperty,i=Object.defineProperty||function(e,t,r){e[t]=r.value},a="function"==typeof Symbol?Symbol:{},o=a.iterator||"@@iterator",c=a.asyncIterator||"@@asyncIterator",_=a.toStringTag||"@@toStringTag";function h(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{h({},"")}catch(e){h=function(e,t,r){return e[t]=r}}function f(e,t,r,n){var a=t&&t.prototype instanceof m?t:m,o=Object.create(a.prototype),s=new B(n||[]);return i(o,"_invoke",{value:E(e,r,s)}),o}function l(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}t.wrap=f;var d="suspendedStart",g="suspendedYield",v="executing",p="completed",y={};function m(){}function b(){}function w(){}var C={};h(C,o,(function(){return this}));var I=Object.getPrototypeOf,x=I&&I(I(j([])));x&&x!==r&&n.call(x,o)&&(C=x);var A=w.prototype=m.prototype=Object.create(C);function D(e){["next","throw","return"].forEach((function(t){h(e,t,(function(e){return this._invoke(t,e)}))}))}function M(e,t){function r(i,a,o,c){var _=l(e[i],e,a);if("throw"!==_.type){var h=_.arg,u=h.value;return u&&"object"==s(u)&&n.call(u,"__await")?t.resolve(u.__await).then((function(e){r("next",e,o,c)}),(function(e){r("throw",e,o,c)})):t.resolve(u).then((function(e){h.value=e,o(h)}),(function(e){return r("throw",e,o,c)}))}c(_.arg)}var a;i(this,"_invoke",{value:function(e,n){function i(){return new t((function(t,i){r(e,n,t,i)}))}return a=a?a.then(i,i):i()}})}function E(t,r,n){var i=d;return function(a,o){if(i===v)throw Error("Generator is already running");if(i===p){if("throw"===a)throw o;return{value:e,done:!0}}for(n.method=a,n.arg=o;;){var s=n.delegate;if(s){var c=L(s,n);if(c){if(c===y)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(i===d)throw i=p,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);i=v;var _=l(t,r,n);if("normal"===_.type){if(i=n.done?p:g,_.arg===y)continue;return{value:_.arg,done:n.done}}"throw"===_.type&&(i=p,n.method="throw",n.arg=_.arg)}}}function L(t,r){var n=r.method,i=t.iterator[n];if(i===e)return r.delegate=null,"throw"===n&&t.iterator.return&&(r.method="return",r.arg=e,L(t,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),y;var a=l(i,t.iterator,r.arg);if("throw"===a.type)return r.method="throw",r.arg=a.arg,r.delegate=null,y;var o=a.arg;return o?o.done?(r[t.resultName]=o.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=e),r.delegate=null,y):o:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,y)}function S(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function k(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function B(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(S,this),this.reset(!0)}function j(t){if(t||""===t){var r=t[o];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var i=-1,a=function r(){for(;++i<t.length;)if(n.call(t,i))return r.value=t[i],r.done=!1,r;return r.value=e,r.done=!0,r};return a.next=a}}throw new TypeError(s(t)+" is not iterable")}return b.prototype=w,i(A,"constructor",{value:w,configurable:!0}),i(w,"constructor",{value:b,configurable:!0}),b.displayName=h(w,_,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===b||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,w):(e.__proto__=w,h(e,_,"GeneratorFunction")),e.prototype=Object.create(A),e},t.awrap=function(e){return{__await:e}},D(M.prototype),h(M.prototype,c,(function(){return this})),t.AsyncIterator=M,t.async=function(e,r,n,i,a){void 0===a&&(a=Promise);var o=new M(f(e,r,n,i),a);return t.isGeneratorFunction(r)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},D(A),h(A,_,"Generator"),h(A,o,(function(){return this})),h(A,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),r=[];for(var n in t)r.push(n);return r.reverse(),function e(){for(;r.length;){var n=r.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},t.values=j,B.prototype={constructor:B,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(k),!t)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var r=this;function i(n,i){return s.type="throw",s.arg=t,r.next=n,i&&(r.method="next",r.arg=e),!!i}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],s=o.completion;if("root"===o.tryLoc)return i("end");if(o.tryLoc<=this.prev){var c=n.call(o,"catchLoc"),_=n.call(o,"finallyLoc");if(c&&_){if(this.prev<o.catchLoc)return i(o.catchLoc,!0);if(this.prev<o.finallyLoc)return i(o.finallyLoc)}else if(c){if(this.prev<o.catchLoc)return i(o.catchLoc,!0)}else{if(!_)throw Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return i(o.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var i=this.tryEntries[r];if(i.tryLoc<=this.prev&&n.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var a=i;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var o=a?a.completion:{};return o.type=e,o.arg=t,a?(this.method="next",this.next=a.finallyLoc,y):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),y},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),k(r),y}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var i=n.arg;k(r)}return i}}throw Error("illegal catch attempt")},delegateYield:function(t,r,n){return this.delegate={iterator:j(t),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=e),y}},t}function f(e,t,r,n,i,a,o){try{var s=e[a](o),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,i)}function l(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var a=e.apply(t,r);function o(e){f(a,n,i,o,s,"next",e)}function s(e){f(a,n,i,o,s,"throw",e)}o(void 0)}))}}function d(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function g(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,I(n.key),n)}}function v(e,t,r){return t&&g(e.prototype,t),r&&g(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function p(e,t,r){return t=m(t),function(e,t){if(t&&("object"==s(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(e,y()?Reflect.construct(t,r||[],m(e).constructor):t.apply(e,r))}function y(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(y=function(){return!!e})()}function m(e){return m=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},m(e)}function b(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&w(e,t)}function w(e,t){return w=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},w(e,t)}function C(e,t,r){return(t=I(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function I(e){var t=function(e,t){if("object"!=s(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!=s(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==s(t)?t:t+""}var x=function(e){function t(e,r,a,s,c,_,h){var f;switch(d(this,t),C(f=p(this,t,[e]),"updateInnerImage",function(){var e=l(u().mark((function e(t){var r,i;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(f._innerImage=t,0!==f._mirageSize?f._innerImage.width>f._innerImage.height?(f._width=f._mirageSize,f._height=Math.ceil(f._innerImage.height*f._mirageSize/f._innerImage.width)):(f._height=f._mirageSize,f._width=Math.ceil(f._innerImage.width*f._mirageSize/f._innerImage.height)):(f._width=f._innerImage.width,f._height=f._innerImage.height),!f._byteArray){e.next=8;break}return e.next=5,f._adjustSize();case 5:r=e.sent,n.i.showSize(f._hiddenMetaCanvas.querySelector(".sizeLabel"),r),console.log("Size to be encoded: "+r);case 8:f._innerCanvas.width=f._width,f._innerCanvas.height=f._height,(i=f._innerCanvas.getContext("2d")).drawImage(t,0,0,f._width,f._height),f._innerImageData=i.getImageData(0,0,f._width,f._height),f._sizeLabel.innerHTML="输出图像预计尺寸：".concat(f._width,"x").concat(f._height),f.convertGray(f._innerImageData),n.i.adjustImageData(f._innerCanvas,f._innerImageData,f._innerContrast,f._innerLuminance),f._isAddMark&&f.addMark(f._innerCanvas),f._coverImageData&&f.updateCoverImage(f._coverImage);case 18:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),C(f,"_adjustSize",l(u().mark((function e(){return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise(function(){var e=l(u().mark((function e(t,r){var i,a,o,s,c;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=f._width*f._height,!((a=f._encoders[f._version].getRequiredLength(f._byteArray,f._diff))>i)){e.next=39;break}if(o=a/i,!f._hiddenFile.type.startsWith("image")||f._hiddenFile.type.startsWith("image/gif")){e.next=31;break}return e.next=7,n.i.showMetaCanvas(f._hiddenMetaCanvas,f._hiddenUrl,f._fileExtension,f._hiddenFile.size);case 7:if(!f._isCompress){e.next=28;break}if(!(s=f._hiddenCanvas.getContext("2d").getImageData(0,0,f._hiddenCanvas.width,f._hiddenCanvas.height))){e.next=28;break}if(c=f._JpegEncoder.encode(s,f._compressQuality),a=f._encoders[f._version].getRequiredLength(c,f._diff),!((o=a/i)>1)){e.next=22;break}return o=Math.sqrt(o),e.next=17,n.i.showMetaCanvas(f._hiddenMetaCanvas,f._hiddenUrl,f._fileExtension,f._hiddenFile.size,1/o);case 17:s=f._hiddenCanvas.getContext("2d").getImageData(0,0,f._hiddenCanvas.width,f._hiddenCanvas.height),c=f._JpegEncoder.encode(s,f._compressQuality),a=f._encoders[f._version].getRequiredLength(c,f._diff),(o=a/i)>1&&f._scaleSize(o);case 22:return f._hiddenSizeLabel.innerHTML="隐藏图像尺寸：".concat(f._hiddenCanvas.width,"x").concat(f._hiddenCanvas.height),f._byteArrayCompressed=c,f._fileExtensionCompressed="jpg",f._hiddenMetaCanvas.querySelector(".typeLabel").innerText="里文件类型：image/jpeg",t(f._byteArrayCompressed.length),e.abrupt("return");case 28:f._hiddenSizeLabel.innerHTML="隐藏图像尺寸：".concat(f._hiddenCanvas.width,"x").concat(f._hiddenCanvas.height),e.next=34;break;case 31:f._hiddenSizeLabel.innerHTML="",f._byteArrayCompressed=null,f._fileExtensionCompressed="";case 34:return f._scaleSize(o),t(f._byteArray.length),e.abrupt("return");case 39:return f._byteArrayCompressed=null,f._fileExtensionCompressed="",t(f._byteArray.length),e.abrupt("return");case 43:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}}),e)})))),C(f,"_scaleSize",(function(e){e=Math.sqrt(e),f._width=Math.ceil(f._width*e),f._height=Math.ceil(f._height*e)})),C(f,"updateHiddenFile",function(){var e=l(u().mark((function e(t){var r,i;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return f._hiddenFile=t,f._byteArrayCompressed=null,f._hiddenUrl&&URL.revokeObjectURL(f._hiddenUrl),f._hiddenUrl=URL.createObjectURL(t),r=t.name,-1!==(i=r.lastIndexOf("."))&&i<r.length-1?(f._fileExtension=r.substring(i+1).toLowerCase(),f._fileExtension.length>10&&(alert("文件拓展名过长，已截断为: "+f._fileExtension.substring(0,10)),f._fileExtension=f._fileExtension.substring(0,10))):f._fileExtension="",e.next=9,n.i.showMetaCanvas(f._hiddenMetaCanvas,f._hiddenUrl,f._fileExtension,t.size);case 9:t.type.startsWith("image/")&&!t.type.startsWith("image/gif")?f._hiddenSizeLabel.innerHTML="隐藏图像尺寸: ".concat(f._hiddenCanvas.width,"x").concat(f._hiddenCanvas.height):f._hiddenSizeLabel.innerHTML="",f._getHiddenByteArray();case 11:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),C(f,"_getHiddenByteArray",(function(){var e=new FileReader;e.onload=function(e){var t=e.target.result;f._byteArray=new Uint8Array(t),f._innerImage&&f.updateInnerImage(f._innerImage)},e.readAsArrayBuffer(f._hiddenFile)})),C(f,"process",(function(){if(!f._innerImageData||!f._coverImageData||!f._byteArray)throw new Error("请先选择图像和文件！");var e=f._innerCanvas.getContext("2d").getImageData(0,0,f._width,f._height),t=f._coverCanvas.getContext("2d").getImageData(0,0,f._width,f._height);console.log("Encoding..."),console.log("    Version: "+f._version),console.log("    Output size: "+f._width+"x"+f._height),console.log("    Size to be encoded: "+(f._isCompress&&f._byteArrayCompressed?f._byteArrayCompressed.length:f._byteArray.length)),console.log("    File extension: "+(f._isCompress&&f._fileExtensionCompressed?f._fileExtensionCompressed:f._fileExtension)),console.log("    Difference: "+f._diff),f._outputData=f._encoders[f._version].encode(e,t,f._isCompress&&f._byteArrayCompressed?f._byteArrayCompressed:f._byteArray,f._isCompress&&f._fileExtensionCompressed?f._fileExtensionCompressed:f._fileExtension,f._diff),f._outputCanvas.width=f._width,f._outputCanvas.height=f._height;var r=new ImageData(f._outputData,f._width,f._height);f._outputCanvas.getContext("2d").putImageData(r,0,0),f._isOutputCanvasCleared=!1,console.log("Encoding finished")})),C(f,"convertGray",(function(e){for(var t=e.data,r=0;r<t.length;r+=4){var n=.299*t[r]+.587*t[r+1]+.114*t[r+2];t[r]=n,t[r+1]=n,t[r+2]=n}})),C(f,"adjustInnerContrast",(function(e){f._innerContrast=e,f._innerImageData&&(n.i.adjustImageData(f._innerCanvas,f._innerImageData,e,f._innerLuminance),f._isAddMark&&f.addMark(f._innerCanvas))})),C(f,"adjustCoverContrast",(function(e){f._coverContrast=e,f._coverImageData&&(n.i.adjustImageData(f._coverCanvas,f._coverImageData,e,f._coverLuminance),f._isAddMark&&f.addMark(f._coverCanvas))})),C(f,"adjustInnerLuminance",(function(e){f._innerLuminance=e,f._innerImageData&&(n.i.adjustImageData(f._innerCanvas,f._innerImageData,f._innerContrast,e),f._isAddMark&&f.addMark(f._innerCanvas))})),C(f,"adjustCoverLuminance",(function(e){f._coverLuminance=e,f._coverImageData&&(n.i.adjustImageData(f._coverCanvas,f._coverImageData,f._coverContrast,e),f._isAddMark&&f.addMark(f._coverCanvas))})),C(f,"saveOutputImage",(function(){if(!f._outputData)throw new Error("请先处理图像！");var e=(new Date).getTime(),t=document.createElement("a"),r=new Blob([(0,i.lF)({width:f._width,height:f._height,data:f._outputData})],{type:"image/png"});t.href=URL.createObjectURL(r),t.download="encoded_".concat(e,".png"),document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(t.href)})),C(f,"setIsAddMark",(function(e){f._isAddMark=e,e?(f._innerImageData&&f.addMark(f._innerCanvas),f._coverImageData&&f.addMark(f._coverCanvas)):(f._innerImageData&&n.i.adjustImageData(f._innerCanvas,f._innerImageData,f._innerContrast,f._innerLuminance),f._coverImageData&&n.i.adjustImageData(f._coverCanvas,f._coverImageData,f._coverContrast,f._coverLuminance))})),C(f,"setMirageSize",(function(e){f._mirageSize=e,f._innerImage&&f.updateInnerImage(f._innerImage)})),C(f,"setDiff",(function(e){f._diff=e,0===f._version&&f._byteArray&&f._innerImage&&f.updateInnerImage(f._innerImage)})),C(f,"setVersion",(function(e){f._version=e,f._byteArray&&f._innerImage&&f.updateInnerImage(f._innerImage)})),C(f,"setIsCompress",function(){var e=l(u().mark((function e(t){return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:f._isCompress=t,f._byteArray&&f._innerImage&&f.updateInnerImage(f._innerImage);case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),C(f,"clearOutputCanvas",(function(){f._isOutputCanvasCleared||(n.i.clearCanvas(f._outputCanvas),f._isOutputCanvasCleared=!0,f._outputData=null)})),f._innerImage=null,f._coverImage=null,f._innerImageData=null,f._coverImageData=null,f._innerContrast=e.contrast_inner,f._coverContrast=e.contrast_cover,f._innerLuminance=e.luminance_inner,f._coverLuminance=e.luminance_cover,f._mirageSize=e.mirage_size,f._isCompress=e.encode_compress,f._compressQuality=e.encode_compress_quality,f._version=e.version,f._version){case 0:f._diff=e.version_0.difference;break;case 1:f._diff=e.version_1.difference;break;case 2:f._diff=e.version_2.difference}return f._hiddenFile=null,f._fileExtension="",f._fileExtensionCompressed="",f._byteArray=null,f._byteArrayCompressed=null,f._outputData=null,f._innerCanvas=document.getElementById(r),f._coverCanvas=document.getElementById(a),f._hiddenMetaCanvas=document.getElementById(s),f._hiddenCanvas=f._hiddenMetaCanvas.querySelector("canvas"),f._outputCanvas=document.getElementById(c),f._sizeLabel=document.getElementById(_),f._hiddenSizeLabel=document.getElementById(h),f._isAddMark=e.add_mark,f._markRatio=e.mark_ratio,f._JpegEncoder=new o(f._compressQuality),f._encoders=[new M(e),new A(e),new D(e)],f}return b(t,e),v(t,[{key:"updateCoverImage",value:function(e){if(this._coverImage=e,this._innerImage){var t,r,i,a,o=e.width/e.height;o<this._width/this._height?(t=0,r=Math.ceil((this._height-this._width/o)/2),i=this._width,a=Math.ceil(this._width/o)):(t=Math.ceil((this._width-this._height*o)/2),r=0,i=Math.ceil(this._height*o),a=this._height),this._coverCanvas.width=this._width,this._coverCanvas.height=this._height;var s=this._coverCanvas.getContext("2d");s.drawImage(e,t,r,i,a),this._coverImageData=s.getImageData(0,0,this._width,this._height)}else{this._coverCanvas.width=e.width,this._coverCanvas.height=e.height;var c=this._coverCanvas.getContext("2d");c.drawImage(e,0,0),this._coverImageData=c.getImageData(0,0,e.width,e.height)}this.convertGray(this._coverImageData),n.i.adjustImageData(this._coverCanvas,this._coverImageData,this._coverContrast,this._coverLuminance),this._isAddMark&&this.addMark(this._coverCanvas)}},{key:"addMark",value:function(e,t){if(!t){if(!applicationState.markImage)return;t=applicationState.markImage}var r=e.width*this._markRatio,n=e.height*this._markRatio,i=r/n,a=t.width/t.height;i>a?r=n*a:n=r/a,e.getContext("2d").drawImage(t,0,0,r,n)}}])}(n.i),A=function(){return v((function e(t){var r=this;d(this,e),C(this,"_getBits",(function(e){var t=e%3,n=Math.floor(e/3);return 0===n?r._getBitsFromByte(r._version,t):1===n?r._getBitsFromByte(Math.floor(r._diff/2),t):n<=5?r._getBitsFromByte(r._targetSize>>(n-2<<3)&255,t):n<r._remained?n-6<r._fileExtension.length?r._getBitsFromByte(r._fileExtension.charCodeAt(n-6),t):r._getBitsFromByte(0,t):n<r._targetSize+r._remained?r._getBitsFromByte(r._byteArray[n-r._remained],t):r._getRandomBits()})),C(this,"_scale",(function(e,t,r){return Math.floor(e*t+r)})),C(this,"_isInner",(function(e){return(e%r._width+Math.floor(e/r._width))%2==0})),C(this,"_getBitsFromByte",(function(e,t){var n=e>>3*t,i=1&n,a=n>>1&1;return 2!=t?{r:i,g:a,b:n>>2&1}:{r:i,g:a,b:r._calParityBit(e)}})),C(this,"_getRandomBits",(function(){return{r:Math.random()>.5?1:0,g:Math.random()>.5?1:0,b:Math.random()>.5?1:0}})),C(this,"_calParityBit",(function(e){for(var t=0,r=0;r<8;r++)t^=e>>r&1;return t})),this._version=1,this._globalDefaultDiff=t.default_difference,this._defaultDiff=t.version_1.default_difference,this._remained=t.version_1.remained,this._padding=t.version_1.padding,this._scale_i=t.version_1.scale_inner,this._offset_i=t.version_1.offset_inner,this._scale_c=t.version_1.scale_cover,this._offset_c=t.version_1.offset_cover}),[{key:"encode",value:function(e,t,r,n,i){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1;if(this._innerData=e.data,this._coverData=t.data,this._width=e.width,this._height=e.height,this._pixelRange=1===a?this._innerData.length>>2:3,1===a&&this._pixelRange<this.getRequiredLength(r))throw new Error("可用像素过少，编码空间不足！");this._version=a;var o=new Uint8ClampedArray(this._innerData.length);this._byteArray=r,this._targetSize=this._byteArray.length,this._fileExtension=n,this._diff=i||this._defaultDiff;for(var s=0;s<this._pixelRange;s++){var c=s<3?this._globalDefaultDiff:s<6?this._defaultDiff:this._diff;if(this._isInner(s)){var _=this._scale(this._innerData[4*s],this._scale_i,this._offset_i),h=this._getBits(s),u=h.r,f=h.g,l=h.b;o[4*s]=u?255-c:255,o[4*s+1]=f?255-c:255,o[4*s+2]=l?255-c:255,o[4*s+3]=_}else{var d=this._scale(this._coverData[4*s],this._scale_c,this._offset_c),g=this._getBits(s),v=g.r,p=g.g,y=g.b;o[4*s]=v?c:0,o[4*s+1]=p?c:0,o[4*s+2]=y?c:0,o[4*s+3]=255-d}}return o}},{key:"getRequiredLength",value:function(e){return 3*(e.length+this._remained+this._padding)}}])}(),D=function(e){function t(e){var r;return d(this,t),C(r=p(this,t,[e]),"_getBitsPair",(function(e){var t=e%3,n=Math.floor(e/3);return n<2?r._getBitsFromBytePair(Math.floor(r._diff/6),t):n<4?r._getBitsFromBytePair(r._targetSize>>(n-2<<4)&65535,t):n<r._remained?n-4<r._fileExtension.length?r._getBitsFromBytePair(r._fileExtension.charCodeAt(n-4),t):r._getBitsFromByte(0,t):n<Math.ceil(r._targetSize/2)+r._remained?r._getBitsFromBytePair(r._byteArray[n-r._remained<<1]|r._byteArray[1+(n-r._remained<<1)]<<8,t):r._getRandomBits()})),C(r,"_getBitsFromBytePair",(function(e,t){var n=e>>6*t,i=3&n,a=n>>2&3;return 2!=t?{r:i,g:a,b:n>>4&3}:{r:i,g:a,b:r._calParityBitPair(e)}})),C(r,"_calParityBitPair",(function(e){for(var t=0,r=0;r<8;r++)t^=e>>r&1;for(var n=8;n<16;n++)t^=(e>>n&1)<<1;return t})),C(r,"_getRandomBits",(function(){return{r:Math.floor(4*Math.random()),g:Math.floor(4*Math.random()),b:Math.floor(4*Math.random())}})),r._version=2,r._defaultDiff=e.version_2.default_difference,r._remained=e.version_2.remained,r._padding=e.version_2.padding,r._scale_i=e.version_2.scale_inner,r._offset_i=e.version_2.offset_inner,r._scale_c=e.version_2.scale_cover,r._offset_c=e.version_2.offset_cover,r}return b(t,e),v(t,[{key:"getRequiredLength",value:function(e){return 3*(e.length>>1+this._remained+this._padding)}},{key:"encode",value:function(e,r,n,i,a){var o=function(e,t,r,n){var i=h(m(1&n?e.prototype:e),t,r);return 2&n?function(e){return i.apply(r,e)}:i}(t,"encode",this,3)([e,r,n,i,void 0,this._version]);if(this._diff=a,this._pixelRange=e.data.length>>2,this._pixelRange<this.getRequiredLength(n))throw new Error("可用像素过少，编码空间不足！");if(1&this._targetSize){var s=new Uint8Array(this._targetSize+1);s.set(this._byteArray),s[this._targetSize]=0,this._byteArray=s}for(var c=3;c<this._pixelRange;c++){var _=Math.floor((c<6?this._defaultDiff:this._diff)/3);if(this._isInner(c)){var u=this._scale(this._innerData[4*c],this._scale_i,this._offset_i),f=this._getBitsPair(c),l=f.r,d=f.g,g=f.b;o[4*c]=255-_*l,o[4*c+1]=255-_*d,o[4*c+2]=255-_*g,o[4*c+3]=u}else{var v=this._scale(this._coverData[4*c],this._scale_c,this._offset_c),p=this._getBitsPair(c),y=p.r,b=p.g,w=p.b;o[4*c]=_*y,o[4*c+1]=_*b,o[4*c+2]=_*w,o[4*c+3]=255-v}}return o}}])}(A),M=v((function e(t){var r=this;d(this,e),C(this,"encode",(function(e,t,i,a,o){var s,_,h,u=e.data,f=t.data,l=e.width,d=u.length>>2;r._targetSize=i.length,r._compress=r._calCompress(o||r._defaultDiff);var g=new Uint8ClampedArray(u.length);if(g[0]=248,g[1]=251,g[2]=248|r._compress,g[3]=r._scaleInner(u[0]),r._byteArray=[],(s=r._byteArray).push.apply(s,c(r._targetSize.toString().split("").map((function(e){return e.charCodeAt(0)})))),r._byteArray.push(1),(_=r._byteArray).push.apply(_,c(("mtc."+a).split("").map((function(e){return e.charCodeAt(0)})))),r._byteArray.push(1),(h=r._byteArray).push.apply(h,c(n.i.classifyFileType(a).split("").map((function(e){return e.charCodeAt(0)})))),r._byteArray.push(0),r._fileArray=i,r._byteArray.length>r._padding)throw new Error("头部信息过长！可尝试更改文件拓展名。");r._bytePos=0,r._buffer=0,r._bufferSize=0;for(var v=255&~((1<<r._compress)-1),p=1;p<d;p++){var y=(p%l+Math.floor(p/l))%2==0;g[4*p]=y?v|r._popBits():r._popBits(),g[4*p+1]=y?v|r._popBits():r._popBits(),g[4*p+2]=y?v|r._popBits():r._popBits(),g[4*p+3]=y?r._scaleInner(u[4*p]):255-r._scaleCover(f[4*p])}if(r._bytePos<r._byteArray.length+r._targetSize)throw new Error("可用像素过少，编码空间不足！");return g})),C(this,"getRequiredLength",(function(e,t){var n=r._calCompress(t);return Math.ceil((r._padding+e.length<<3)/n/3)+1})),C(this,"_calCompress",(function(e){return Math.min(Math.max(Math.floor(e/10),1),7)})),C(this,"_pushByte",(function(){var e=r._bytePos<r._byteArray.length?r._byteArray[r._bytePos]:r._bytePos<r._byteArray.length+r._targetSize?r._fileArray[r._bytePos-r._byteArray.length]:Math.floor(256*Math.random());r._bytePos++,r._buffer=r._buffer<<8|e,r._bufferSize+=8})),C(this,"_popBits",(function(){r._bufferSize<r._compress&&r._pushByte();var e=(r._buffer&(1<<r._compress)-1<<r._bufferSize-r._compress)>>r._bufferSize-r._compress;return r._bufferSize-=r._compress,r._buffer&=(1<<r._bufferSize)-1,e})),C(this,"_scaleInner",(function(e){return Math.floor(e*r._scale_i+r._offset_i)})),C(this,"_scaleCover",(function(e){return Math.floor(e*r._scale_c+r._offset_c)})),this._defaultDiff=t.version_0.default_difference,this._padding=t.version_0.padding,this._scale_i=t.version_0.scale_inner,this._offset_i=t.version_0.offset_inner,this._scale_c=t.version_0.scale_cover,this._offset_c=t.version_0.offset_cover}))}}]);