/*! For license information please see 38.343b7220581db24d9802.js.LICENSE.txt */
"use strict";(self.webpackChunkmirage_cloak=self.webpackChunkmirage_cloak||[]).push([[38],{38:(e,t,r)=>{r.r(t),r.d(t,{CloakEncoder:()=>A});var n=r(490),i=r(23),a=r(287).hp;function o(e){Math.round;var t,r,n,i,o,s=Math.floor,c=new Array(64),h=new Array(64),u=new Array(64),_=new Array(64),f=new Array(65535),d=new Array(65535),l=new Array(64),g=new Array(64),v=[],y=0,p=7,m=new Array(64),b=new Array(64),w=new Array(64),C=new Array(256),I=new Array(2048),x=[0,1,5,6,14,15,27,28,2,4,7,13,16,26,29,42,3,8,12,17,25,30,41,43,9,11,18,24,31,40,44,53,10,19,23,32,39,45,52,54,20,22,33,38,46,51,55,60,21,34,37,47,50,56,59,61,35,36,48,49,57,58,62,63],A=[0,0,1,5,1,1,1,1,1,1,0,0,0,0,0,0,0],D=[0,1,2,3,4,5,6,7,8,9,10,11],M=[0,0,2,1,3,3,2,4,3,5,5,4,4,0,0,1,125],E=[1,2,3,0,4,17,5,18,33,49,65,6,19,81,97,7,34,113,20,50,129,145,161,8,35,66,177,193,21,82,209,240,36,51,98,114,130,9,10,22,23,24,25,26,37,38,39,40,41,42,52,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,225,226,227,228,229,230,231,232,233,234,241,242,243,244,245,246,247,248,249,250],B=[0,0,3,1,1,1,1,1,1,1,1,1,0,0,0,0,0],L=[0,1,2,3,4,5,6,7,8,9,10,11],S=[0,0,2,1,2,4,4,3,4,7,5,4,4,0,1,2,119],k=[0,1,2,3,17,4,5,33,49,6,18,65,81,7,97,113,19,34,50,129,8,20,66,145,161,177,193,9,35,51,82,240,21,98,114,209,10,22,36,52,225,37,241,23,24,25,26,38,39,40,41,42,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,130,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,226,227,228,229,230,231,232,233,234,242,243,244,245,246,247,248,249,250];function j(e,t){for(var r=0,n=0,i=new Array,a=1;a<=16;a++){for(var o=1;o<=e[a];o++)i[t[n]]=[],i[t[n]][0]=r,i[t[n]][1]=a,n++,r++;r*=2}return i}function z(e){for(var t=e[0],r=e[1]-1;r>=0;)t&1<<r&&(y|=1<<p),r--,--p<0&&(255==y?(O(255),O(0)):O(y),p=7,y=0)}function O(e){v.push(e)}function P(e){O(e>>8&255),O(255&e)}function R(e,t,r,n,i){for(var a,o=i[0],s=i[240],c=function(e,t){var r,n,i,a,o,s,c,h,u,_,f=0;for(u=0;u<8;++u){r=e[f],n=e[f+1],i=e[f+2],a=e[f+3],o=e[f+4],s=e[f+5],c=e[f+6];var d=r+(h=e[f+7]),g=r-h,v=n+c,y=n-c,p=i+s,m=i-s,b=a+o,w=a-o,C=d+b,I=d-b,x=v+p,A=v-p;e[f]=C+x,e[f+4]=C-x;var D=.707106781*(A+I);e[f+2]=I+D,e[f+6]=I-D;var M=.382683433*((C=w+m)-(A=y+g)),E=.5411961*C+M,B=1.306562965*A+M,L=.707106781*(x=m+y),S=g+L,k=g-L;e[f+5]=k+E,e[f+3]=k-E,e[f+1]=S+B,e[f+7]=S-B,f+=8}for(f=0,u=0;u<8;++u){r=e[f],n=e[f+8],i=e[f+16],a=e[f+24],o=e[f+32],s=e[f+40],c=e[f+48];var j=r+(h=e[f+56]),z=r-h,O=n+c,P=n-c,R=i+s,F=i-s,T=a+o,U=a-o,q=j+T,G=j-T,N=O+R,H=O-R;e[f]=q+N,e[f+32]=q-N;var Q=.707106781*(H+G);e[f+16]=G+Q,e[f+48]=G-Q;var W=.382683433*((q=U+F)-(H=P+z)),J=.5411961*q+W,V=1.306562965*H+W,Y=.707106781*(N=F+P),$=z+Y,K=z-Y;e[f+40]=K+J,e[f+24]=K-J,e[f+8]=$+V,e[f+56]=$-V,f++}for(u=0;u<64;++u)_=e[u]*t[u],l[u]=_>0?_+.5|0:_-.5|0;return l}(e,t),h=0;h<64;++h)g[x[h]]=c[h];var u=g[0]-r;r=g[0],0==u?z(n[0]):(z(n[d[a=32767+u]]),z(f[a]));for(var _=63;_>0&&0==g[_];_--);if(0==_)return z(o),r;for(var v,y=1;y<=_;){for(var p=y;0==g[y]&&y<=_;++y);var m=y-p;if(m>=16){v=m>>4;for(var b=1;b<=v;++b)z(s);m&=15}a=32767+g[y],z(i[(m<<4)+d[a]]),z(f[a]),y++}return 63!=_&&z(o),r}function F(e){if(e<=0&&(e=1),e>100&&(e=100),o!=e){(function(e){for(var t=[16,11,10,16,24,40,51,61,12,12,14,19,26,58,60,55,14,13,16,24,40,57,69,56,14,17,22,29,51,87,80,62,18,22,37,56,68,109,103,77,24,35,55,64,81,104,113,92,49,64,78,87,103,121,120,101,72,92,95,98,112,100,103,99],r=0;r<64;r++){var n=s((t[r]*e+50)/100);n<1?n=1:n>255&&(n=255),c[x[r]]=n}for(var i=[17,18,24,47,99,99,99,99,18,21,26,66,99,99,99,99,24,26,56,99,99,99,99,99,47,66,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99],a=0;a<64;a++){var o=s((i[a]*e+50)/100);o<1?o=1:o>255&&(o=255),h[x[a]]=o}for(var f=[1,1.387039845,1.306562965,1.175875602,1,.785694958,.5411961,.275899379],d=0,l=0;l<8;l++)for(var g=0;g<8;g++)u[d]=1/(c[x[d]]*f[l]*f[g]*8),_[d]=1/(h[x[d]]*f[l]*f[g]*8),d++})(e<50?Math.floor(5e3/e):Math.floor(200-2*e)),o=e}}this.encode=function(e,o){var s;(new Date).getTime();o&&F(o),v=new Array,y=0,p=7,P(65496),P(65504),P(16),O(74),O(70),O(73),O(70),O(0),O(1),O(1),O(0),P(1),P(1),O(0),O(0),void 0!==(s=e.comments)&&s.constructor===Array&&s.forEach((function(e){if("string"==typeof e){P(65534);var t,r=e.length;for(P(r+2),t=0;t<r;t++)O(e.charCodeAt(t))}})),function(e){if(e){P(65505),69===e[0]&&120===e[1]&&105===e[2]&&102===e[3]?P(e.length+2):(P(e.length+5+2),O(69),O(120),O(105),O(102),O(0));for(var t=0;t<e.length;t++)O(e[t])}}(e.exifBuffer),function(){P(65499),P(132),O(0);for(var e=0;e<64;e++)O(c[e]);O(1);for(var t=0;t<64;t++)O(h[t])}(),function(e,t){P(65472),P(17),O(8),P(t),P(e),O(3),O(1),O(17),O(0),O(2),O(17),O(1),O(3),O(17),O(1)}(e.width,e.height),function(){P(65476),P(418),O(0);for(var e=0;e<16;e++)O(A[e+1]);for(var t=0;t<=11;t++)O(D[t]);O(16);for(var r=0;r<16;r++)O(M[r+1]);for(var n=0;n<=161;n++)O(E[n]);O(1);for(var i=0;i<16;i++)O(B[i+1]);for(var a=0;a<=11;a++)O(L[a]);O(17);for(var o=0;o<16;o++)O(S[o+1]);for(var s=0;s<=161;s++)O(k[s])}(),P(65498),P(12),O(3),O(1),O(0),O(2),O(17),O(3),O(17),O(0),O(63),O(0);var f=0,d=0,l=0;y=0,p=7,this.encode.displayName="_encode_";for(var g,C,x,j,T,U,q,G,N,H=e.data,Q=e.width,W=e.height,J=4*Q,V=0;V<W;){for(g=0;g<J;){for(U=T=J*V+g,q=-1,G=0,N=0;N<64;N++)U=T+(G=N>>3)*J+(q=4*(7&N)),V+G>=W&&(U-=J*(V+1+G-W)),g+q>=J&&(U-=g+q-J+4),C=H[U++],x=H[U++],j=H[U++],m[N]=(I[C]+I[x+256|0]+I[j+512|0]>>16)-128,b[N]=(I[C+768|0]+I[x+1024|0]+I[j+1280|0]>>16)-128,w[N]=(I[C+1280|0]+I[x+1536|0]+I[j+1792|0]>>16)-128;f=R(m,u,f,t,n),d=R(b,_,d,r,i),l=R(w,_,l,r,i),g+=32}V+=8}if(p>=0){var Y=[];Y[1]=p+1,Y[0]=(1<<p+1)-1,z(Y)}return P(65497),a.from(v)},function(){(new Date).getTime();e||(e=50),function(){for(var e=String.fromCharCode,t=0;t<256;t++)C[t]=e(t)}(),t=j(A,D),r=j(B,L),n=j(M,E),i=j(S,k),function(){for(var e=1,t=2,r=1;r<=15;r++){for(var n=e;n<t;n++)d[32767+n]=r,f[32767+n]=[],f[32767+n][1]=r,f[32767+n][0]=n;for(var i=-(t-1);i<=-e;i++)d[32767+i]=r,f[32767+i]=[],f[32767+i][1]=r,f[32767+i][0]=t-1+i;e<<=1,t<<=1}}(),function(){for(var e=0;e<256;e++)I[e]=19595*e,I[e+256|0]=38470*e,I[e+512|0]=7471*e+32768,I[e+768|0]=-11059*e,I[e+1024|0]=-21709*e,I[e+1280|0]=32768*e+8421375,I[e+1536|0]=-27439*e,I[e+1792|0]=-5329*e}(),F(e),(new Date).getTime()}()}var s=r(8);function c(e){return c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},c(e)}function h(e){return function(e){if(Array.isArray(e))return u(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return u(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?u(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function u(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function _(){return _="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=function(e,t){for(;!{}.hasOwnProperty.call(e,t)&&null!==(e=b(e)););return e}(e,t);if(n){var i=Object.getOwnPropertyDescriptor(n,t);return i.get?i.get.call(arguments.length<3?e:r):i.value}},_.apply(null,arguments)}function f(){f=function(){return t};var e,t={},r=Object.prototype,n=r.hasOwnProperty,i=Object.defineProperty||function(e,t,r){e[t]=r.value},a="function"==typeof Symbol?Symbol:{},o=a.iterator||"@@iterator",s=a.asyncIterator||"@@asyncIterator",h=a.toStringTag||"@@toStringTag";function u(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{u({},"")}catch(e){u=function(e,t,r){return e[t]=r}}function _(e,t,r,n){var a=t&&t.prototype instanceof m?t:m,o=Object.create(a.prototype),s=new k(n||[]);return i(o,"_invoke",{value:E(e,r,s)}),o}function d(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}t.wrap=_;var l="suspendedStart",g="suspendedYield",v="executing",y="completed",p={};function m(){}function b(){}function w(){}var C={};u(C,o,(function(){return this}));var I=Object.getPrototypeOf,x=I&&I(I(j([])));x&&x!==r&&n.call(x,o)&&(C=x);var A=w.prototype=m.prototype=Object.create(C);function D(e){["next","throw","return"].forEach((function(t){u(e,t,(function(e){return this._invoke(t,e)}))}))}function M(e,t){function r(i,a,o,s){var h=d(e[i],e,a);if("throw"!==h.type){var u=h.arg,_=u.value;return _&&"object"==c(_)&&n.call(_,"__await")?t.resolve(_.__await).then((function(e){r("next",e,o,s)}),(function(e){r("throw",e,o,s)})):t.resolve(_).then((function(e){u.value=e,o(u)}),(function(e){return r("throw",e,o,s)}))}s(h.arg)}var a;i(this,"_invoke",{value:function(e,n){function i(){return new t((function(t,i){r(e,n,t,i)}))}return a=a?a.then(i,i):i()}})}function E(t,r,n){var i=l;return function(a,o){if(i===v)throw Error("Generator is already running");if(i===y){if("throw"===a)throw o;return{value:e,done:!0}}for(n.method=a,n.arg=o;;){var s=n.delegate;if(s){var c=B(s,n);if(c){if(c===p)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(i===l)throw i=y,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);i=v;var h=d(t,r,n);if("normal"===h.type){if(i=n.done?y:g,h.arg===p)continue;return{value:h.arg,done:n.done}}"throw"===h.type&&(i=y,n.method="throw",n.arg=h.arg)}}}function B(t,r){var n=r.method,i=t.iterator[n];if(i===e)return r.delegate=null,"throw"===n&&t.iterator.return&&(r.method="return",r.arg=e,B(t,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),p;var a=d(i,t.iterator,r.arg);if("throw"===a.type)return r.method="throw",r.arg=a.arg,r.delegate=null,p;var o=a.arg;return o?o.done?(r[t.resultName]=o.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=e),r.delegate=null,p):o:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,p)}function L(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function S(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function k(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(L,this),this.reset(!0)}function j(t){if(t||""===t){var r=t[o];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var i=-1,a=function r(){for(;++i<t.length;)if(n.call(t,i))return r.value=t[i],r.done=!1,r;return r.value=e,r.done=!0,r};return a.next=a}}throw new TypeError(c(t)+" is not iterable")}return b.prototype=w,i(A,"constructor",{value:w,configurable:!0}),i(w,"constructor",{value:b,configurable:!0}),b.displayName=u(w,h,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===b||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,w):(e.__proto__=w,u(e,h,"GeneratorFunction")),e.prototype=Object.create(A),e},t.awrap=function(e){return{__await:e}},D(M.prototype),u(M.prototype,s,(function(){return this})),t.AsyncIterator=M,t.async=function(e,r,n,i,a){void 0===a&&(a=Promise);var o=new M(_(e,r,n,i),a);return t.isGeneratorFunction(r)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},D(A),u(A,h,"Generator"),u(A,o,(function(){return this})),u(A,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),r=[];for(var n in t)r.push(n);return r.reverse(),function e(){for(;r.length;){var n=r.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},t.values=j,k.prototype={constructor:k,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(S),!t)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var r=this;function i(n,i){return s.type="throw",s.arg=t,r.next=n,i&&(r.method="next",r.arg=e),!!i}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],s=o.completion;if("root"===o.tryLoc)return i("end");if(o.tryLoc<=this.prev){var c=n.call(o,"catchLoc"),h=n.call(o,"finallyLoc");if(c&&h){if(this.prev<o.catchLoc)return i(o.catchLoc,!0);if(this.prev<o.finallyLoc)return i(o.finallyLoc)}else if(c){if(this.prev<o.catchLoc)return i(o.catchLoc,!0)}else{if(!h)throw Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return i(o.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var i=this.tryEntries[r];if(i.tryLoc<=this.prev&&n.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var a=i;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var o=a?a.completion:{};return o.type=e,o.arg=t,a?(this.method="next",this.next=a.finallyLoc,p):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),p},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),S(r),p}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var i=n.arg;S(r)}return i}}throw Error("illegal catch attempt")},delegateYield:function(t,r,n){return this.delegate={iterator:j(t),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=e),p}},t}function d(e,t,r,n,i,a,o){try{var s=e[a](o),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,i)}function l(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var a=e.apply(t,r);function o(e){d(a,n,i,o,s,"next",e)}function s(e){d(a,n,i,o,s,"throw",e)}o(void 0)}))}}function g(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function v(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,x(n.key),n)}}function y(e,t,r){return t&&v(e.prototype,t),r&&v(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function p(e,t,r){return t=b(t),function(e,t){if(t&&("object"==c(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(e,m()?Reflect.construct(t,r||[],b(e).constructor):t.apply(e,r))}function m(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(m=function(){return!!e})()}function b(e){return b=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},b(e)}function w(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&C(e,t)}function C(e,t){return C=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},C(e,t)}function I(e,t,r){return(t=x(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function x(e){var t=function(e,t){if("object"!=c(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!=c(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==c(t)?t:t+""}var A=function(e){function t(e,r,a,c,h,u,_){var d;switch(g(this,t),I(d=p(this,t,[e]),"updateInnerImage",function(){var e=l(f().mark((function e(t){var r,i;return f().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s.I.showBusy(),d._innerImage=t,0!==d._mirageSize?d._innerImage.width>d._innerImage.height?(d._width=d._mirageSize,d._height=Math.ceil(d._innerImage.height*d._mirageSize/d._innerImage.width)):(d._height=d._mirageSize,d._width=Math.ceil(d._innerImage.width*d._mirageSize/d._innerImage.height)):(d._width=d._innerImage.width,d._height=d._innerImage.height),!d._byteArray){e.next=9;break}return e.next=6,d._adjustSize();case 6:r=e.sent,n.i.showSize(d._hiddenMetaCanvas.querySelector(".sizeLabel"),r),console.log("Size to be encoded: "+r);case 9:d._innerCanvas.width=d._width,d._innerCanvas.height=d._height,(i=d._innerCanvas.getContext("2d")).drawImage(t,0,0,d._width,d._height),d._innerImageData=i.getImageData(0,0,d._width,d._height),d._sizeLabel.innerHTML="输出图像预计尺寸：".concat(d._width,"x").concat(d._height),d.convertGray(d._innerImageData),n.i.adjustImageData(d._innerCanvas,d._innerImageData,d._innerContrast,d._innerLuminance),d._isAddMark&&d.addMark(d._innerCanvas),d._coverImageData?d.updateCoverImage(d._coverImage):s.I.hideBusy();case 19:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),I(d,"_adjustSize",l(f().mark((function e(){return f().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise(function(){var e=l(f().mark((function e(t,r){var i,a,o,s,c;return f().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=d._width*d._height,!((a=d._encoders[d._version].getRequiredLength(d._byteArray,d._diff))>i)){e.next=39;break}if(o=a/i,!d._hiddenFile.type.startsWith("image")||d._hiddenFile.type.startsWith("image/gif")){e.next=31;break}return e.next=7,n.i.showMetaCanvas(d._hiddenMetaCanvas,d._hiddenUrl,d._fileExtension,d._hiddenFile.size);case 7:if(!d._isCompress){e.next=28;break}if(!(s=d._hiddenCanvas.getContext("2d").getImageData(0,0,d._hiddenCanvas.width,d._hiddenCanvas.height))){e.next=28;break}if(c=d._JpegEncoder.encode(s,d._compressQuality),a=d._encoders[d._version].getRequiredLength(c,d._diff),!((o=a/i)>1)){e.next=22;break}return o=Math.sqrt(o),e.next=17,n.i.showMetaCanvas(d._hiddenMetaCanvas,d._hiddenUrl,d._fileExtension,d._hiddenFile.size,1/o);case 17:s=d._hiddenCanvas.getContext("2d").getImageData(0,0,d._hiddenCanvas.width,d._hiddenCanvas.height),c=d._JpegEncoder.encode(s,d._compressQuality),a=d._encoders[d._version].getRequiredLength(c,d._diff),(o=a/i)>1&&d._scaleSize(o);case 22:return d._hiddenSizeLabel.innerHTML="隐藏图像尺寸：".concat(d._hiddenCanvas.width,"x").concat(d._hiddenCanvas.height),d._byteArrayCompressed=c,d._fileExtensionCompressed="jpg",d._hiddenMetaCanvas.querySelector(".typeLabel").innerText="里文件类型：image/jpeg",t(d._byteArrayCompressed.length),e.abrupt("return");case 28:d._hiddenSizeLabel.innerHTML="隐藏图像尺寸：".concat(d._hiddenCanvas.width,"x").concat(d._hiddenCanvas.height),e.next=34;break;case 31:d._hiddenSizeLabel.innerHTML="",d._byteArrayCompressed=null,d._fileExtensionCompressed="";case 34:return d._scaleSize(o),t(d._byteArray.length),e.abrupt("return");case 39:return d._byteArrayCompressed=null,d._fileExtensionCompressed="",t(d._byteArray.length),e.abrupt("return");case 43:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}}),e)})))),I(d,"_scaleSize",(function(e){e=Math.sqrt(e),d._width=Math.ceil(d._width*e),d._height=Math.ceil(d._height*e)})),I(d,"updateHiddenFile",function(){var e=l(f().mark((function e(t){var r,i;return f().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s.I.showBusy(),d._hiddenFile=t,d._byteArrayCompressed=null,d._hiddenUrl&&URL.revokeObjectURL(d._hiddenUrl),d._hiddenUrl=URL.createObjectURL(t),r=t.name,-1!==(i=r.lastIndexOf("."))&&i<r.length-1?(d._fileExtension=r.substring(i+1).toLowerCase(),d._fileExtension.length>10&&(alert("文件拓展名过长，已截断为: "+d._fileExtension.substring(0,10)),d._fileExtension=d._fileExtension.substring(0,10))):d._fileExtension="",e.next=10,n.i.showMetaCanvas(d._hiddenMetaCanvas,d._hiddenUrl,d._fileExtension,t.size);case 10:t.type.startsWith("image/")&&!t.type.startsWith("image/gif")?d._hiddenSizeLabel.innerHTML="隐藏图像尺寸: ".concat(d._hiddenCanvas.width,"x").concat(d._hiddenCanvas.height):d._hiddenSizeLabel.innerHTML="",d._getHiddenByteArray();case 12:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),I(d,"_getHiddenByteArray",(function(){var e=new FileReader;e.onload=function(e){var t=e.target.result;d._byteArray=new Uint8Array(t),d._innerImage?d.updateInnerImage(d._innerImage):s.I.hideBusy()},e.readAsArrayBuffer(d._hiddenFile)})),I(d,"process",(function(){try{if(!d._innerImageData||!d._coverImageData||!d._byteArray)throw new Error("请先选择图像和文件！");s.I.showBusy();var e=d._innerCanvas.getContext("2d").getImageData(0,0,d._width,d._height),t=d._coverCanvas.getContext("2d").getImageData(0,0,d._width,d._height);console.log("Encoding..."),console.log("    Version: "+d._version),console.log("    Output size: "+d._width+"x"+d._height),console.log("    Size to be encoded: "+(d._isCompress&&d._byteArrayCompressed?d._byteArrayCompressed.length:d._byteArray.length)),console.log("    File extension: "+(d._isCompress&&d._fileExtensionCompressed?d._fileExtensionCompressed:d._fileExtension)),console.log("    Difference: "+d._diff),d._outputData=d._encoders[d._version].encode(e,t,d._isCompress&&d._byteArrayCompressed?d._byteArrayCompressed:d._byteArray,d._isCompress&&d._fileExtensionCompressed?d._fileExtensionCompressed:d._fileExtension,d._diff),d._outputCanvas.width=d._width,d._outputCanvas.height=d._height;var r=new ImageData(d._outputData,d._width,d._height);d._outputCanvas.getContext("2d").putImageData(r,0,0),d._isOutputCanvasCleared=!1,s.I.hideBusy(),console.log("Encoding finished")}catch(e){s.I.hideBusy(),alert("编码失败："+e.message)}})),I(d,"convertGray",(function(e){for(var t=e.data,r=0;r<t.length;r+=4){var n=.299*t[r]+.587*t[r+1]+.114*t[r+2];t[r]=n,t[r+1]=n,t[r+2]=n}})),I(d,"adjustInnerContrast",(function(e){d._innerContrast=e,d._innerImageData&&(n.i.adjustImageData(d._innerCanvas,d._innerImageData,e,d._innerLuminance),d._isAddMark&&d.addMark(d._innerCanvas))})),I(d,"adjustCoverContrast",(function(e){d._coverContrast=e,d._coverImageData&&(n.i.adjustImageData(d._coverCanvas,d._coverImageData,e,d._coverLuminance),d._isAddMark&&d.addMark(d._coverCanvas))})),I(d,"adjustInnerLuminance",(function(e){d._innerLuminance=e,d._innerImageData&&(n.i.adjustImageData(d._innerCanvas,d._innerImageData,d._innerContrast,e),d._isAddMark&&d.addMark(d._innerCanvas))})),I(d,"adjustCoverLuminance",(function(e){d._coverLuminance=e,d._coverImageData&&(n.i.adjustImageData(d._coverCanvas,d._coverImageData,d._coverContrast,e),d._isAddMark&&d.addMark(d._coverCanvas))})),I(d,"saveOutputImage",(function(){if(!d._outputData)throw new Error("请先处理图像！");s.I.showBusy();var e=(new Date).getTime(),t=document.createElement("a"),r=new Blob([(0,i.lF)({width:d._width,height:d._height,data:d._outputData})],{type:"image/png"});t.href=URL.createObjectURL(r),t.download="encoded_".concat(e,".png"),document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(t.href),s.I.hideBusy()})),I(d,"setIsAddMark",(function(e){d._isAddMark=e,e?(d._innerImageData&&d.addMark(d._innerCanvas),d._coverImageData&&d.addMark(d._coverCanvas)):(d._innerImageData&&n.i.adjustImageData(d._innerCanvas,d._innerImageData,d._innerContrast,d._innerLuminance),d._coverImageData&&n.i.adjustImageData(d._coverCanvas,d._coverImageData,d._coverContrast,d._coverLuminance))})),I(d,"setMirageSize",(function(e){d._mirageSize=e,d._innerImage&&d.updateInnerImage(d._innerImage)})),I(d,"setDiff",(function(e){d._diff=e,0===d._version&&d._byteArray&&d._innerImage&&d.updateInnerImage(d._innerImage)})),I(d,"setVersion",(function(e){d._version=e,d._byteArray&&d._innerImage&&d.updateInnerImage(d._innerImage)})),I(d,"setIsCompress",function(){var e=l(f().mark((function e(t){return f().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:d._isCompress=t,d._byteArray&&d._innerImage&&d.updateInnerImage(d._innerImage);case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),I(d,"clearOutputCanvas",(function(){d._isOutputCanvasCleared||(n.i.clearCanvas(d._outputCanvas),d._isOutputCanvasCleared=!0,d._outputData=null)})),d._innerImage=null,d._coverImage=null,d._innerImageData=null,d._coverImageData=null,d._innerContrast=e.contrast_inner,d._coverContrast=e.contrast_cover,d._innerLuminance=e.luminance_inner,d._coverLuminance=e.luminance_cover,d._mirageSize=e.mirage_size,d._isCompress=e.encode_compress,d._compressQuality=e.encode_compress_quality,d._version=e.version,d._version){case 0:d._diff=e.version_0.difference;break;case 1:d._diff=e.version_1.difference;break;case 2:d._diff=e.version_2.difference}return d._hiddenFile=null,d._fileExtension="",d._fileExtensionCompressed="",d._byteArray=null,d._byteArrayCompressed=null,d._outputData=null,d._innerCanvas=document.getElementById(r),d._coverCanvas=document.getElementById(a),d._hiddenMetaCanvas=document.getElementById(c),d._hiddenCanvas=d._hiddenMetaCanvas.querySelector("canvas"),d._outputCanvas=document.getElementById(h),d._sizeLabel=document.getElementById(u),d._hiddenSizeLabel=document.getElementById(_),d._isAddMark=e.add_mark,d._markRatio=e.mark_ratio,d._JpegEncoder=new o(d._compressQuality),d._encoders=[new E(e),new D(e),new M(e)],d}return w(t,e),y(t,[{key:"updateCoverImage",value:function(e){if(s.I.showBusy(),this._coverImage=e,this._innerImage){var t,r,i,a,o=e.width/e.height;o<this._width/this._height?(t=0,r=Math.ceil((this._height-this._width/o)/2),i=this._width,a=Math.ceil(this._width/o)):(t=Math.ceil((this._width-this._height*o)/2),r=0,i=Math.ceil(this._height*o),a=this._height),this._coverCanvas.width=this._width,this._coverCanvas.height=this._height;var c=this._coverCanvas.getContext("2d");c.drawImage(e,t,r,i,a),this._coverImageData=c.getImageData(0,0,this._width,this._height)}else{this._coverCanvas.width=e.width,this._coverCanvas.height=e.height;var h=this._coverCanvas.getContext("2d");h.drawImage(e,0,0),this._coverImageData=h.getImageData(0,0,e.width,e.height)}this.convertGray(this._coverImageData),n.i.adjustImageData(this._coverCanvas,this._coverImageData,this._coverContrast,this._coverLuminance),this._isAddMark&&this.addMark(this._coverCanvas),s.I.hideBusy()}},{key:"addMark",value:function(e,t){if(!t){if(!applicationState.markImage)return;t=applicationState.markImage}var r=e.width*this._markRatio,n=e.height*this._markRatio,i=r/n,a=t.width/t.height;i>a?r=n*a:n=r/a,e.getContext("2d").drawImage(t,0,0,r,n)}}])}(n.i),D=function(){return y((function e(t){var r=this;g(this,e),I(this,"_getBits",(function(e){var t=e%3,n=Math.floor(e/3);return 0===n?r._getBitsFromByte(r._version,t):1===n?r._getBitsFromByte(Math.floor(r._diff/2),t):n<=5?r._getBitsFromByte(r._targetSize>>(n-2<<3)&255,t):n<r._remained?n-6<r._fileExtension.length?r._getBitsFromByte(r._fileExtension.charCodeAt(n-6),t):r._getBitsFromByte(0,t):n<r._targetSize+r._remained?r._getBitsFromByte(r._byteArray[n-r._remained],t):r._getRandomBits()})),I(this,"_scale",(function(e,t,r){return Math.floor(e*t+r)})),I(this,"_isInner",(function(e){return(e%r._width+Math.floor(e/r._width))%2==0})),I(this,"_getBitsFromByte",(function(e,t){var n=e>>3*t,i=1&n,a=n>>1&1;return 2!=t?{r:i,g:a,b:n>>2&1}:{r:i,g:a,b:r._calParityBit(e)}})),I(this,"_getRandomBits",(function(){return{r:Math.random()>.5?1:0,g:Math.random()>.5?1:0,b:Math.random()>.5?1:0}})),I(this,"_calParityBit",(function(e){for(var t=0,r=0;r<8;r++)t^=e>>r&1;return t})),this._version=1,this._globalDefaultDiff=t.default_difference,this._defaultDiff=t.version_1.default_difference,this._remained=t.version_1.remained,this._padding=t.version_1.padding,this._scale_i=t.version_1.scale_inner,this._offset_i=t.version_1.offset_inner,this._scale_c=t.version_1.scale_cover,this._offset_c=t.version_1.offset_cover}),[{key:"encode",value:function(e,t,r,n,i){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1;if(this._innerData=e.data,this._coverData=t.data,this._width=e.width,this._height=e.height,this._pixelRange=1===a?this._innerData.length>>2:3,1===a&&this._pixelRange<this.getRequiredLength(r))throw new Error("可用像素过少，编码空间不足！");this._version=a;var o=new Uint8ClampedArray(this._innerData.length);this._byteArray=r,this._targetSize=this._byteArray.length,this._fileExtension=n,this._diff=i||this._defaultDiff;for(var s=0;s<this._pixelRange;s++){var c=s<3?this._globalDefaultDiff:s<6?this._defaultDiff:this._diff;if(this._isInner(s)){var h=this._scale(this._innerData[4*s],this._scale_i,this._offset_i),u=this._getBits(s),_=u.r,f=u.g,d=u.b;o[4*s]=_?255-c:255,o[4*s+1]=f?255-c:255,o[4*s+2]=d?255-c:255,o[4*s+3]=h}else{var l=this._scale(this._coverData[4*s],this._scale_c,this._offset_c),g=this._getBits(s),v=g.r,y=g.g,p=g.b;o[4*s]=v?c:0,o[4*s+1]=y?c:0,o[4*s+2]=p?c:0,o[4*s+3]=255-l}}return o}},{key:"getRequiredLength",value:function(e){return 3*(e.length+this._remained+this._padding)}}])}(),M=function(e){function t(e){var r;return g(this,t),I(r=p(this,t,[e]),"_getBitsPair",(function(e){var t=e%3,n=Math.floor(e/3);return n<2?r._getBitsFromBytePair(Math.floor(r._diff/6),t):n<4?r._getBitsFromBytePair(r._targetSize>>(n-2<<4)&65535,t):n<r._remained?n-4<r._fileExtension.length?r._getBitsFromBytePair(r._fileExtension.charCodeAt(n-4),t):r._getBitsFromByte(0,t):n<Math.ceil(r._targetSize/2)+r._remained?r._getBitsFromBytePair(r._byteArray[n-r._remained<<1]|r._byteArray[1+(n-r._remained<<1)]<<8,t):r._getRandomBits()})),I(r,"_getBitsFromBytePair",(function(e,t){var n=e>>6*t,i=3&n,a=n>>2&3;return 2!=t?{r:i,g:a,b:n>>4&3}:{r:i,g:a,b:r._calParityBitPair(e)}})),I(r,"_calParityBitPair",(function(e){for(var t=0,r=0;r<8;r++)t^=e>>r&1;for(var n=8;n<16;n++)t^=(e>>n&1)<<1;return t})),I(r,"_getRandomBits",(function(){return{r:Math.floor(4*Math.random()),g:Math.floor(4*Math.random()),b:Math.floor(4*Math.random())}})),r._version=2,r._defaultDiff=e.version_2.default_difference,r._remained=e.version_2.remained,r._padding=e.version_2.padding,r._scale_i=e.version_2.scale_inner,r._offset_i=e.version_2.offset_inner,r._scale_c=e.version_2.scale_cover,r._offset_c=e.version_2.offset_cover,r}return w(t,e),y(t,[{key:"getRequiredLength",value:function(e){return 3*(e.length>>1+this._remained+this._padding)}},{key:"encode",value:function(e,r,n,i,a){var o=function(e,t,r,n){var i=_(b(1&n?e.prototype:e),t,r);return 2&n?function(e){return i.apply(r,e)}:i}(t,"encode",this,3)([e,r,n,i,void 0,this._version]);if(this._diff=a,this._pixelRange=e.data.length>>2,this._pixelRange<this.getRequiredLength(n))throw new Error("可用像素过少，编码空间不足！");if(1&this._targetSize){var s=new Uint8Array(this._targetSize+1);s.set(this._byteArray),s[this._targetSize]=0,this._byteArray=s}for(var c=3;c<this._pixelRange;c++){var h=Math.floor((c<6?this._defaultDiff:this._diff)/3);if(this._isInner(c)){var u=this._scale(this._innerData[4*c],this._scale_i,this._offset_i),f=this._getBitsPair(c),d=f.r,l=f.g,g=f.b;o[4*c]=255-h*d,o[4*c+1]=255-h*l,o[4*c+2]=255-h*g,o[4*c+3]=u}else{var v=this._scale(this._coverData[4*c],this._scale_c,this._offset_c),y=this._getBitsPair(c),p=y.r,m=y.g,w=y.b;o[4*c]=h*p,o[4*c+1]=h*m,o[4*c+2]=h*w,o[4*c+3]=255-v}}return o}}])}(D),E=y((function e(t){var r=this;g(this,e),I(this,"encode",(function(e,t,i,a,o){var s,c,u,_=e.data,f=t.data,d=e.width,l=_.length>>2;r._targetSize=i.length,r._compress=r._calCompress(o||r._defaultDiff);var g=new Uint8ClampedArray(_.length);if(g[0]=248,g[1]=251,g[2]=248|r._compress,g[3]=r._scaleInner(_[0]),r._byteArray=[],(s=r._byteArray).push.apply(s,h(r._targetSize.toString().split("").map((function(e){return e.charCodeAt(0)})))),r._byteArray.push(1),(c=r._byteArray).push.apply(c,h(("mtc."+a).split("").map((function(e){return e.charCodeAt(0)})))),r._byteArray.push(1),(u=r._byteArray).push.apply(u,h(n.i.classifyFileType(a).split("").map((function(e){return e.charCodeAt(0)})))),r._byteArray.push(0),r._fileArray=i,r._byteArray.length>r._padding)throw new Error("头部信息过长！可尝试更改文件拓展名。");r._bytePos=0,r._buffer=0,r._bufferSize=0;for(var v=255&~((1<<r._compress)-1),y=1;y<l;y++){var p=(y%d+Math.floor(y/d))%2==0;g[4*y]=p?v|r._popBits():r._popBits(),g[4*y+1]=p?v|r._popBits():r._popBits(),g[4*y+2]=p?v|r._popBits():r._popBits(),g[4*y+3]=p?r._scaleInner(_[4*y]):255-r._scaleCover(f[4*y])}if(r._bytePos<r._byteArray.length+r._targetSize)throw new Error("可用像素过少，编码空间不足！");return g})),I(this,"getRequiredLength",(function(e,t){var n=r._calCompress(t);return Math.ceil((r._padding+e.length<<3)/n/3)+1})),I(this,"_calCompress",(function(e){return Math.min(Math.max(Math.floor(e/10),1),7)})),I(this,"_pushByte",(function(){var e=r._bytePos<r._byteArray.length?r._byteArray[r._bytePos]:r._bytePos<r._byteArray.length+r._targetSize?r._fileArray[r._bytePos-r._byteArray.length]:Math.floor(256*Math.random());r._bytePos++,r._buffer=r._buffer<<8|e,r._bufferSize+=8})),I(this,"_popBits",(function(){r._bufferSize<r._compress&&r._pushByte();var e=(r._buffer&(1<<r._compress)-1<<r._bufferSize-r._compress)>>r._bufferSize-r._compress;return r._bufferSize-=r._compress,r._buffer&=(1<<r._bufferSize)-1,e})),I(this,"_scaleInner",(function(e){return Math.floor(e*r._scale_i+r._offset_i)})),I(this,"_scaleCover",(function(e){return Math.floor(e*r._scale_c+r._offset_c)})),this._defaultDiff=t.version_0.default_difference,this._padding=t.version_0.padding,this._scale_i=t.version_0.scale_inner,this._offset_i=t.version_0.offset_inner,this._scale_c=t.version_0.scale_cover,this._offset_c=t.version_0.offset_cover}))}}]);