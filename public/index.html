<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">

    <script>
        // global namespaces
        var applicationState = applicationState || {};
        var errorHandling = errorHandling || {};
        errorHandling.scriptsLoaded = errorHandling.scriptsLoaded || {};
        var CloakProcessor = CloakProcessor || {};
    </script>
    <script>
        applicationState.version = '1.0.6.1';
        // version check
        (() => {
            console.log('target version:', applicationState.version);
            console.log('local version:', localStorage.getItem('version'));
            const previousVersion = localStorage.getItem('version');
            if (!previousVersion || previousVersion !== applicationState.version) {
                console.log('new version detected, clearing cache');
                localStorage.clear();
                localStorage.setItem('version', applicationState.version);
                location.reload(true);
            }
        })();
        // cache busting, just in case
        var scripts = document.querySelectorAll('script[data-version]');
        scripts.forEach(function (script) {
            var src = script.getAttribute('src');
            if (src) {
                script.setAttribute('src', src + '?v=' + applicationState.version);
            }
        });
        var links = document.querySelectorAll('link[rel="stylesheet"]');
        links.forEach(function (link) {
            var href = link.getAttribute('href');
            if (href) {
                link.setAttribute('href', href + '?v=' + applicationState.version);
            }
        });
    </script>

    <script>
        function applyTheme(tarTheme) {
            if (tarTheme === undefined || typeof tarTheme !== 'string') {
                const prefersDarkScheme = window.matchMedia("(prefers-color-scheme: dark)").matches;
                tarTheme = prefersDarkScheme ? "dark" : "light";
            }
            document.documentElement.setAttribute("data-theme", tarTheme);
            const isDarkmodeCheckbox = document.getElementById('isDarkmodeCheckbox');
            if (isDarkmodeCheckbox) {
                isDarkmodeCheckbox.checked = tarTheme === 'dark';
            } else {
                document.addEventListener('DOMContentLoaded', function () {
                    const isDarkmodeCheckbox = document.getElementById('isDarkmodeCheckbox');
                    isDarkmodeCheckbox.checked = tarTheme === 'dark';
                });
            }
            const isDarkModeLabel = document.getElementById('isDarkModeLabel');
            if (isDarkModeLabel) {
                isDarkModeLabel.innerText = tarTheme === 'dark' ? '开灯' : '关灯';
            } else {
                document.addEventListener('DOMContentLoaded', function () {
                    const isDarkModeLabel = document.getElementById('isDarkModeLabel');
                    isDarkModeLabel.innerText = tarTheme === 'dark' ? '开灯' : '关灯';
                });
            }
        }
        applyTheme();
        window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", applyTheme);
    </script>

    <script>
        // test if all scripts are loaded
        document.addEventListener('DOMContentLoaded', function () {
            const requiredScripts = [
                'pngLib',
                'jpegEncoder',
                'DefaultArguments',
                'CloakUniversal',
                'CloakDecoder',
                'CloakEncoder',
                'ImageLoader',
                'UniversalListeners',
                'DecodeListeners',
                'EncodeListeners',
                'init'
            ];
            let allLoaded = true;
            for (let i = 0; i < requiredScripts.length; i++) {
                if (!errorHandling.scriptsLoaded[requiredScripts[i]]) {
                    console.error('Script not loaded:', requiredScripts[i]);
                    allLoaded = false;
                }
            }
            if (allLoaded) {
                console.log('All scripts loaded successfully.');
            } else {
                alert('部分脚本未能成功加载，请刷新页面重试。可尝试清理浏览器缓存。');
            }
        });
    </script>

    <!-- <link rel="icon" href="local/neko.ico" type="image/x-icon"> -->

    <title>幻影坦克Ultra</title>

    <link rel="stylesheet" type="text/css" href="./css/style.css">
    <link rel="stylesheet" type="text/css" href="./css/classes.css">
    <link rel="stylesheet" type="text/css" href="./css/switch.css">
    <script id="jsonPath" data-json-path="./DefaultArguments.json" defer></script>
    <!-- <script src="../scripts/libs/pngLib.js" defer data-version></script>
    <script src="../scripts/libs/jpegEncoder.js" defer data-version></script>
    <script src="../scripts/DefaultArguments.js" defer data-version></script>
    <script src="../scripts/processors/CloakUniversal.js" defer data-version></script>
    <script src="../scripts/processors/CloakDecoder.js" defer data-version></script>
    <script src="../scripts/processors/CloakEncoder.js" defer data-version></script>
    <script src="../scripts/listeners/ImageLoader.js" defer data-version></script>
    <script src="../scripts/listeners/DecodeListeners.js" defer data-version></script>
    <script src="../scripts/listeners/EncodeListeners.js" defer data-version></script>
    <script src="../scripts/listeners/UniversalListeners.js" defer data-version></script>
    <script src="../scripts/init.js" defer data-version></script> -->
    <script src="./src/packed.js" defer data-version></script>

</head>

<body class="flexColumn marginTopHigh displayFlex justifyCenter alignCenter marginTopHigh backgroundPrimary frontColor">

    <div class="displayFlex flexRow justifyCenter alignCenter">
        <h1 class="title">幻光火箭炮工厂</h1>
        <h2 class="subTitle">(暂定)</h2>
    </div>

    <a class="fontMedium frontLinkColor marginTopMedium transformSize textDecorationNone" target="_blank"
        href="https://github.com/Uyanide/Mirage_Cloak">⌈ 一种基于棋盘格幻影坦克的无影(类lsb)隐写术 ⌋</a>

    <div class="PageContainer displayFlex justifyCenter alignCenter flexColumn refWidthHigh paddingHigh fontMedium">

        <div class="TitleContainer displayFlex justifySpaceBetween alignCenter flexRow gapLow refWidthFull">
            <button
                class="PageSwitchButton paddingHigh refWidthFull borderRadiusOnlyTop fontMedium transformSecondary frontColor borderSolidNone"
                id="decodeButton"><b>显形</b></button>
            <button
                class="PageSwitchButton paddingHigh refWidthFull borderRadiusOnlyTop fontMedium transformSecondary frontColor borderSolidNone"
                id="encodeButton"><b>制作</b></button>
        </div>

        <div class="DisplayArea frontColor borderRadiusOnlyBottom justifyCenter alignCenter flexColumn refWidthFull backgroundSecondary"
            id="decodePage">
            <div id="decodeImageSelect" class="displayFlex flexColumn alignCenter marginTopHigh ">
                <div id="decodeFileInput" class="displayFlex alignCenter">
                    <label for="decodeImageFileInput"
                        class="fileInputLabel marginLeftLow inputReact transformSize">选择图片文件</label>
                    <input type="file" id="decodeImageFileInput" accept="image/*">
                </div>
                <div id="decodePasteInput" class="marginTopMedium">
                    或从剪贴板粘贴图片 (ctrl+v),
                </div>
                <div id="decodePasteButton" class="flexRow alignCenter marginTopMedium">
                    <label for="decodePasteButtonInput">或从剪贴板</label>
                    <button id="decodePasteButtonInput" class="inputReact marginLeftLow transformSize">粘贴图片</button>
                </div>
                <div id="decodeDragInputHint" class="marginTopMedium">
                    或直接将图片拖进窗口。
                </div>
            </div>

            <div class="marginTopHigh">↓ 解码结果 ↓</div>
            <canvas id="decodeOutputCanvas" class="marginTopMedium"></canvas>
            <button id="decodeSaveButton" class="inputReact marginTopMedium transformSize">保存结果</button>

            <div class="marginTopHigh">↓ 原图 ↓</div>
            <canvas id="decodeInputCanvas" class="marginTopMedium"></canvas>
            <div class="marginTopMedium fontSmall">(下方开关灯可切换显示表里图)</div>
            <div class="marginTopLow fontSmall marginBottomExtreme">(若出现摩尔纹可适当缩放网页界面)</div>

        </div>

        <div class="DisplayArea frontColor borderRadiusOnlyBottom justifyCenter alignCenter flexColumn refWidthFull backgroundSecondary"
            id="encodePage">
            <div class="displayFlex flexRow justifyCenter alignCenter marginTopHigh refWidthHigh">
                <div class="encodeFileInput displayFlex flexColumn justifyCenter alignCenter refWidthHalf">
                    <label for="innerSourceFileInput" class="fileInputLabel inputReact transformSize">选择幻坦里图</label>
                    <input type="file" id="innerSourceFileInput" accept="image/*">
                    <label for="innerSourceFileInput" class="encodeDrag marginTopMedium fontSmall">或直接拖动至下方画布</label>
                    <canvas id="innerCanvas" class="refWidthHigh marginTopMedium"></canvas>
                    <slider
                        class="encodeSlider refWidthHigh displayFlex flexColumn alignCenter justifyCenter marginTopMedium">
                        <label for="innerContrastRange" class="encodeSliderTitle">1. 里图对比度: </label>
                        <input type="range" id="innerContrastRange" class="refWidthHigh marginTopLow" min="0" max="100">
                        <button id="innerResetContrastButton" class="inputReact marginTopLow">重置对比度</button>
                        <label for="innerLuminanceRange" class="encodeSliderTitle marginTopMedium">2. 里图亮度: </label>
                        <input type="range" id="innerLuminanceRange" class="refWidthHigh marginTopLow" min="0"
                            max="100">
                        <button id="innerResetLuminanceButton" class="inputReact marginTopLow">重置亮度</button>
                    </slider>
                </div>

                <div class="encodeFileInput displayFlex flexColumn justifyCenter alignCenter refWidthHalf">
                    <label for="coverSourceFileInput" class="fileInputLabel inputReact transformSize">选择幻坦表图</label>
                    <input type="file" id="coverSourceFileInput" accept="image/*">
                    <label for="coverSourceFileInput" class="encodeDrag marginTopMedium fontSmall">或直接拖动至下方画布</label>
                    <canvas id="coverCanvas" class="refWidthHigh marginTopMedium"></canvas>
                    <slider
                        class="encodeSlider  refWidthHigh displayFlex flexColumn alignCenter justifyCenter marginTopMedium">
                        <label for="coverContrastRange" class="encodeSliderTitle">3. 表图对比度: </label>
                        <input type="range" id="coverContrastRange" class="refWidthHigh marginTopLow" min="0" max="100">
                        <button id="coverResetContrastButton" class="inputReact marginTopLow">重置对比度</button>
                        <label for="coverLuminanceRange" class="encodeSliderTitle marginTopMedium">4. 表图亮度: </label>
                        <input type="range" id="coverLuminanceRange" class="refWidthHigh marginTopLow" min="0"
                            max="100">
                        <button id="coverResetLuminanceButton" class="inputReact marginTopLow">重置亮度</button>
                    </slider>
                </div>
            </div>

            <label for="mirageSizeInput" class="marginTopMedium">5. 预期输出尺寸:</label>
            <div class="displyFlex flexRow justifyCenter alignCenter marginTopLow">
                <input id="mirageSizeInput" type="number" class="inputReact"></input>
                <button id="mirageSizeConfirmButton" class="inputReact transformSize marginLeftLow">确认应用</button>
            </div>
            <div class="fontSmall marginTopLow">(指长宽中较大值，0即为不指定)</div>
            <div class="fontSmall marginTopLow">(若隐藏文件过大则实际输出尺寸可能会大于此值)</div>

            <div class="displayFlex flexRow justifyCenter alignCenter marginTopMedium">
                <label for="isAddMarkCheckbox">6. </label>
                <input type="checkbox" id="isAddMarkCheckbox" class="inputReact marginLeftLow marginRightLow">
                <label for="isAddMarkCheckbox">是否添加坦克水印</label>
            </div>

            <div class="diplayFlex flexRow justifyCenter alignCenter marginTopMedium">
                <label for="encodeDiffInput">7. 噪声强度:</label>
                <input type="number" id="encodeDiffInput" class="inputReact marginLeftLow"></input>
            </div>
            <div id="encodeDiffinputHint" class="fontSmall marginTopLow"></div>

            <div class="diplayFlex flexRow justifyCenter alignCenter marginTopMedium">
                <label for="encodeMethodSelect">8. 选择编码方式:</label>
                <select id="encodeMethodSelect" class="inputReact marginLeftLow">
                    <option value="1">双极 (0.33字节/像素)</option>
                    <option value="2">四极 (0.67字节/像素)</option>
                    <option value="0">传统无影 (LSB隐写)</option>
                </select>
            </div>
            <div class="fontSmall marginTopLow">(越靠下的选项隐写效率越高，但抗干扰能力越差)</div>

            <div class="displayFlex flexRow justifyCenter alignCenter marginTopMedium refWidthHigh">
                <label for="isEncodeCompressCheckbox">9. </label>
                <input type="checkbox" id="isEncodeCompressCheckbox"
                    class="inputReact marginLeftLow marginRightLow"></input>
                <label for="isEncodeCompressCheckbox">是否尝试压缩隐写图像以限制输出图像大小</label>
            </div>

            <div class="displayFlex flexRow justifyCenter alignCenter marginTopHigh">
                <label for="hiddenSourceFileInput" class="fileInputLabel inputReact transformSize marginLeftLow">
                    选择隐写文件</label>
                <input type="file" id="hiddenSourceFileInput">
            </div>

            <div class="encodeDrag marginTopMedium fontSmall">或直接拖动至下方画布</div>
            <canvas id="hiddenCanvas" class="marginTopMedium"></canvas>
            <div id="encodeOutputSize" class="marginTopMedium"></div>
            <div class="marginTopLow fontSmall">(若尺寸过大可适当降低"5.预期输出尺寸")</div>
            <div id="encodeHiddenSize" class="marginTopMedium"></div>

            <div class="displayFlex flexRow justifyCenter alignCenter marginTopMedium">
                <button id="encodeProcessButton" class="inputReact marginRightLow transformSize">开始编码</button>
                <button id="encodeSaveButton" class="inputReact transformSize">保存结果</button>
            </div>

            <canvas id="encodeOutputCanvas" class="marginTopMedium marginBottomExtreme"></canvas>

        </div>

        <div class="switchContainer">
            <p id="isDarkModeLabel">切换明/暗主题</p>
            <label class="switch" id="isDarkmodeSwitch">
                <input type="checkbox" id="isDarkmodeCheckbox" title="switch from themes">
                <span class="switchSlider"></span>
            </label>
        </div>

        <div id="pageBelow" class="displayFlex frontColor justifyCenter alignCenter flexColumn">
            <div id="versionInfo" class="fontLarge">version: <b>UNKNOWN</b></div>

            <div class="marginTopLow fontSmall">
                如发现有功能不正常可手动清理浏览器缓存后刷新
            </div>

            <!-- <div class="marginTopMedium fontSmall transformSize">
                <a class="frontLinkColor" href="https://github.com/Uyanide/Mirage_Cloak/issues/new"
                    target="_blank">Bug反馈</a>
            </div> -->

            <div class="marginTopMedium fontSmall transformSize">
                <a class="frontLinkColor" href="https://github.com/Uyanide" target="_blank">Github - Uyanide (我)</a>
            </div>

            <div class="marginTopMedium fontSmall transformSize">
                <a class="frontLinkColor" href="https://github.com/Uyanide/Mirage_Cloak" target="_blank">Github -
                    Mirage_Cloak (本项目仓库)</a>
            </div>

            <!-- <div class="marginTopMedium fontSmall transformSize">
                <a class="frontLinkColor" href="https://github.com/Uyanide/Mirage_Cloak" target="_blank">常见问题Q&A</a>
            </div> -->

            <div id="privacyButton" class="marginTopLow">
                <button id="togglePrivacyPolicy"
                    class="frontLinkColor backgroundPrimary borderNone fontSmall transformSize borderSolidNone">显示使用须知</button>
            </div>

            <div id="privacyPolicy"
                class="backgroundSecondary frontColor fontSmall displayNone paddingHigh borderRadiusExtreme marginTopMedium textAlignCenter">
                <div>本网站仅供个人学习交流使用，禁止一切非法用途，否则一切后果由使用者自行承担。</div>
            </div>

            <div id="versionRecordButton" class="marginTopLow">
                <button id="toggleVersionRecord"
                    class="frontLinkColor backgroundPrimary borderNone fontSmall transformSize borderSolidNone">显示主要更新记录</button>
            </div>

            <div id="versionRecord" class="marginTopMedium marginBottomMedium">
                <table id="versionRecordTable"
                    class="fontSmall paddingHigh borderRadiusExtreme displayNone backgroundSecondary borderCollapse">
                    <tbody>
                        <tr>
                            <td>1.0.0</td>
                            <td>初始版本。
                            </td>
                        </tr>
                        <tr>
                            <td>1.0.1</td>
                            <td>增加亮度调整功能；<br>
                                允许指定输出图像尺寸；<br>
                                增加水印功能，并可选择是否添加；<br>
                                使用UMD模块化所有脚本。
                            </td>
                        </tr>
                        <tr>
                            <td>1.0.2</td>
                            <td>增加了噪声强度手动调节功能。</td>
                        </tr>
                        <tr>
                            <td>1.0.3</td>
                            <td>增加了一种新的编码方式。</td>
                        </tr>
                        <tr>
                            <td>1.0.4</td>
                            <td>使用fast-png库编/解码png以保证数据质量；<br>
                                增加了是否压缩隐写图像的选项。</td>
                        </tr>
                        <tr>
                            <td>1.0.5</td>
                            <td>增加了传统LSB无影坦克隐写作为新模式；</td>
                        </tr>
                        <tr>
                            <td>1.0.6</td>
                            <td>使用webpack打包所有脚本。</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
</body>

</html>