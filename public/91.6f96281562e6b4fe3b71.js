/*! For license information please see 91.6f96281562e6b4fe3b71.js.LICENSE.txt */
"use strict";(self.webpackChunkmirage_cloak=self.webpackChunkmirage_cloak||[]).push([[91],{91:(e,t,r)=>{r.r(t),r.d(t,{CloakEncoder:()=>y});var n=r(490),a=r(287).hp;function i(e){Math.round;var t,r,n,i,o,s=Math.floor,c=new Array(64),u=new Array(64),d=new Array(64),f=new Array(64),h=new Array(65535),l=new Array(65535),_=new Array(64),v=new Array(64),g=[],m=0,p=7,y=new Array(64),w=new Array(64),b=new Array(64),C=new Array(256),x=new Array(2048),I=[0,1,5,6,14,15,27,28,2,4,7,13,16,26,29,42,3,8,12,17,25,30,41,43,9,11,18,24,31,40,44,53,10,19,23,32,39,45,52,54,20,22,33,38,46,51,55,60,21,34,37,47,50,56,59,61,35,36,48,49,57,58,62,63],k=[0,0,1,5,1,1,1,1,1,1,0,0,0,0,0,0,0],L=[0,1,2,3,4,5,6,7,8,9,10,11],E=[0,0,2,1,3,3,2,4,3,5,5,4,4,0,0,1,125],A=[1,2,3,0,4,17,5,18,33,49,65,6,19,81,97,7,34,113,20,50,129,145,161,8,35,66,177,193,21,82,209,240,36,51,98,114,130,9,10,22,23,24,25,26,37,38,39,40,41,42,52,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,225,226,227,228,229,230,231,232,233,234,241,242,243,244,245,246,247,248,249,250],D=[0,0,3,1,1,1,1,1,1,1,1,1,0,0,0,0,0],M=[0,1,2,3,4,5,6,7,8,9,10,11],j=[0,0,2,1,2,4,4,3,4,7,5,4,4,0,1,2,119],S=[0,1,2,3,17,4,5,33,49,6,18,65,81,7,97,113,19,34,50,129,8,20,66,145,161,177,193,9,35,51,82,240,21,98,114,209,10,22,36,52,225,37,241,23,24,25,26,38,39,40,41,42,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,130,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,226,227,228,229,230,231,232,233,234,242,243,244,245,246,247,248,249,250];function O(e,t){for(var r=0,n=0,a=new Array,i=1;i<=16;i++){for(var o=1;o<=e[i];o++)a[t[n]]=[],a[t[n]][0]=r,a[t[n]][1]=i,n++,r++;r*=2}return a}function z(e){for(var t=e[0],r=e[1]-1;r>=0;)t&1<<r&&(m|=1<<p),r--,--p<0&&(255==m?(P(255),P(0)):P(m),p=7,m=0)}function P(e){g.push(e)}function T(e){P(e>>8&255),P(255&e)}function F(e,t,r,n,a){for(var i,o=a[0],s=a[240],c=function(e,t){var r,n,a,i,o,s,c,u,d,f,h=0;for(d=0;d<8;++d){r=e[h],n=e[h+1],a=e[h+2],i=e[h+3],o=e[h+4],s=e[h+5],c=e[h+6];var l=r+(u=e[h+7]),v=r-u,g=n+c,m=n-c,p=a+s,y=a-s,w=i+o,b=i-o,C=l+w,x=l-w,I=g+p,k=g-p;e[h]=C+I,e[h+4]=C-I;var L=.707106781*(k+x);e[h+2]=x+L,e[h+6]=x-L;var E=.382683433*((C=b+y)-(k=m+v)),A=.5411961*C+E,D=1.306562965*k+E,M=.707106781*(I=y+m),j=v+M,S=v-M;e[h+5]=S+A,e[h+3]=S-A,e[h+1]=j+D,e[h+7]=j-D,h+=8}for(h=0,d=0;d<8;++d){r=e[h],n=e[h+8],a=e[h+16],i=e[h+24],o=e[h+32],s=e[h+40],c=e[h+48];var O=r+(u=e[h+56]),z=r-u,P=n+c,T=n-c,F=a+s,R=a-s,B=i+o,N=i-o,U=O+B,G=O-B,q=P+F,H=P-F;e[h]=U+q,e[h+32]=U-q;var W=.707106781*(H+G);e[h+16]=G+W,e[h+48]=G-W;var Q=.382683433*((U=N+R)-(H=T+z)),J=.5411961*U+Q,V=1.306562965*H+Q,Y=.707106781*(q=R+T),K=z+Y,X=z-Y;e[h+40]=X+J,e[h+24]=X-J,e[h+8]=K+V,e[h+56]=K-V,h++}for(d=0;d<64;++d)f=e[d]*t[d],_[d]=f>0?f+.5|0:f-.5|0;return _}(e,t),u=0;u<64;++u)v[I[u]]=c[u];var d=v[0]-r;r=v[0],0==d?z(n[0]):(z(n[l[i=32767+d]]),z(h[i]));for(var f=63;f>0&&0==v[f];f--);if(0==f)return z(o),r;for(var g,m=1;m<=f;){for(var p=m;0==v[m]&&m<=f;++m);var y=m-p;if(y>=16){g=y>>4;for(var w=1;w<=g;++w)z(s);y&=15}i=32767+v[m],z(a[(y<<4)+l[i]]),z(h[i]),m++}return 63!=f&&z(o),r}function R(e){if(e<=0&&(e=1),e>100&&(e=100),o!=e){(function(e){for(var t=[16,11,10,16,24,40,51,61,12,12,14,19,26,58,60,55,14,13,16,24,40,57,69,56,14,17,22,29,51,87,80,62,18,22,37,56,68,109,103,77,24,35,55,64,81,104,113,92,49,64,78,87,103,121,120,101,72,92,95,98,112,100,103,99],r=0;r<64;r++){var n=s((t[r]*e+50)/100);n<1?n=1:n>255&&(n=255),c[I[r]]=n}for(var a=[17,18,24,47,99,99,99,99,18,21,26,66,99,99,99,99,24,26,56,99,99,99,99,99,47,66,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99],i=0;i<64;i++){var o=s((a[i]*e+50)/100);o<1?o=1:o>255&&(o=255),u[I[i]]=o}for(var h=[1,1.387039845,1.306562965,1.175875602,1,.785694958,.5411961,.275899379],l=0,_=0;_<8;_++)for(var v=0;v<8;v++)d[l]=1/(c[I[l]]*h[_]*h[v]*8),f[l]=1/(u[I[l]]*h[_]*h[v]*8),l++})(e<50?Math.floor(5e3/e):Math.floor(200-2*e)),o=e}}this.encode=function(e,o){var s;(new Date).getTime();o&&R(o),g=new Array,m=0,p=7,T(65496),T(65504),T(16),P(74),P(70),P(73),P(70),P(0),P(1),P(1),P(0),T(1),T(1),P(0),P(0),void 0!==(s=e.comments)&&s.constructor===Array&&s.forEach((function(e){if("string"==typeof e){T(65534);var t,r=e.length;for(T(r+2),t=0;t<r;t++)P(e.charCodeAt(t))}})),function(e){if(e){T(65505),69===e[0]&&120===e[1]&&105===e[2]&&102===e[3]?T(e.length+2):(T(e.length+5+2),P(69),P(120),P(105),P(102),P(0));for(var t=0;t<e.length;t++)P(e[t])}}(e.exifBuffer),function(){T(65499),T(132),P(0);for(var e=0;e<64;e++)P(c[e]);P(1);for(var t=0;t<64;t++)P(u[t])}(),function(e,t){T(65472),T(17),P(8),T(t),T(e),P(3),P(1),P(17),P(0),P(2),P(17),P(1),P(3),P(17),P(1)}(e.width,e.height),function(){T(65476),T(418),P(0);for(var e=0;e<16;e++)P(k[e+1]);for(var t=0;t<=11;t++)P(L[t]);P(16);for(var r=0;r<16;r++)P(E[r+1]);for(var n=0;n<=161;n++)P(A[n]);P(1);for(var a=0;a<16;a++)P(D[a+1]);for(var i=0;i<=11;i++)P(M[i]);P(17);for(var o=0;o<16;o++)P(j[o+1]);for(var s=0;s<=161;s++)P(S[s])}(),T(65498),T(12),P(3),P(1),P(0),P(2),P(17),P(3),P(17),P(0),P(63),P(0);var h=0,l=0,_=0;m=0,p=7,this.encode.displayName="_encode_";for(var v,C,I,O,B,N,U,G,q,H=e.data,W=e.width,Q=e.height,J=4*W,V=0;V<Q;){for(v=0;v<J;){for(N=B=J*V+v,U=-1,G=0,q=0;q<64;q++)N=B+(G=q>>3)*J+(U=4*(7&q)),V+G>=Q&&(N-=J*(V+1+G-Q)),v+U>=J&&(N-=v+U-J+4),C=H[N++],I=H[N++],O=H[N++],y[q]=(x[C]+x[I+256|0]+x[O+512|0]>>16)-128,w[q]=(x[C+768|0]+x[I+1024|0]+x[O+1280|0]>>16)-128,b[q]=(x[C+1280|0]+x[I+1536|0]+x[O+1792|0]>>16)-128;h=F(y,d,h,t,n),l=F(w,f,l,r,i),_=F(b,f,_,r,i),v+=32}V+=8}if(p>=0){var Y=[];Y[1]=p+1,Y[0]=(1<<p+1)-1,z(Y)}return T(65497),a.from(g)},function(){(new Date).getTime();e||(e=50),function(){for(var e=String.fromCharCode,t=0;t<256;t++)C[t]=e(t)}(),t=O(k,L),r=O(D,M),n=O(E,A),i=O(j,S),function(){for(var e=1,t=2,r=1;r<=15;r++){for(var n=e;n<t;n++)l[32767+n]=r,h[32767+n]=[],h[32767+n][1]=r,h[32767+n][0]=n;for(var a=-(t-1);a<=-e;a++)l[32767+a]=r,h[32767+a]=[],h[32767+a][1]=r,h[32767+a][0]=t-1+a;e<<=1,t<<=1}}(),function(){for(var e=0;e<256;e++)x[e]=19595*e,x[e+256|0]=38470*e,x[e+512|0]=7471*e+32768,x[e+768|0]=-11059*e,x[e+1024|0]=-21709*e,x[e+1280|0]=32768*e+8421375,x[e+1536|0]=-27439*e,x[e+1792|0]=-5329*e}(),R(e),(new Date).getTime()}()}function o(){return new Worker(r.p+"PngEncoder.worker.c06f09db66e975dd65c7.worker.js")}function s(){return new Worker(r.p+"Encoder.worker.409fd9b1e265a45506a9.worker.js")}function c(e){return c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},c(e)}function u(){u=function(){return t};var e,t={},r=Object.prototype,n=r.hasOwnProperty,a=Object.defineProperty||function(e,t,r){e[t]=r.value},i="function"==typeof Symbol?Symbol:{},o=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",d=i.toStringTag||"@@toStringTag";function f(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{f({},"")}catch(e){f=function(e,t,r){return e[t]=r}}function h(e,t,r,n){var i=t&&t.prototype instanceof y?t:y,o=Object.create(i.prototype),s=new S(n||[]);return a(o,"_invoke",{value:A(e,r,s)}),o}function l(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}t.wrap=h;var _="suspendedStart",v="suspendedYield",g="executing",m="completed",p={};function y(){}function w(){}function b(){}var C={};f(C,o,(function(){return this}));var x=Object.getPrototypeOf,I=x&&x(x(O([])));I&&I!==r&&n.call(I,o)&&(C=I);var k=b.prototype=y.prototype=Object.create(C);function L(e){["next","throw","return"].forEach((function(t){f(e,t,(function(e){return this._invoke(t,e)}))}))}function E(e,t){function r(a,i,o,s){var u=l(e[a],e,i);if("throw"!==u.type){var d=u.arg,f=d.value;return f&&"object"==c(f)&&n.call(f,"__await")?t.resolve(f.__await).then((function(e){r("next",e,o,s)}),(function(e){r("throw",e,o,s)})):t.resolve(f).then((function(e){d.value=e,o(d)}),(function(e){return r("throw",e,o,s)}))}s(u.arg)}var i;a(this,"_invoke",{value:function(e,n){function a(){return new t((function(t,a){r(e,n,t,a)}))}return i=i?i.then(a,a):a()}})}function A(t,r,n){var a=_;return function(i,o){if(a===g)throw Error("Generator is already running");if(a===m){if("throw"===i)throw o;return{value:e,done:!0}}for(n.method=i,n.arg=o;;){var s=n.delegate;if(s){var c=D(s,n);if(c){if(c===p)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(a===_)throw a=m,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);a=g;var u=l(t,r,n);if("normal"===u.type){if(a=n.done?m:v,u.arg===p)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(a=m,n.method="throw",n.arg=u.arg)}}}function D(t,r){var n=r.method,a=t.iterator[n];if(a===e)return r.delegate=null,"throw"===n&&t.iterator.return&&(r.method="return",r.arg=e,D(t,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),p;var i=l(a,t.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,p;var o=i.arg;return o?o.done?(r[t.resultName]=o.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=e),r.delegate=null,p):o:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,p)}function M(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function j(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function S(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(M,this),this.reset(!0)}function O(t){if(t||""===t){var r=t[o];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var a=-1,i=function r(){for(;++a<t.length;)if(n.call(t,a))return r.value=t[a],r.done=!1,r;return r.value=e,r.done=!0,r};return i.next=i}}throw new TypeError(c(t)+" is not iterable")}return w.prototype=b,a(k,"constructor",{value:b,configurable:!0}),a(b,"constructor",{value:w,configurable:!0}),w.displayName=f(b,d,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===w||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,b):(e.__proto__=b,f(e,d,"GeneratorFunction")),e.prototype=Object.create(k),e},t.awrap=function(e){return{__await:e}},L(E.prototype),f(E.prototype,s,(function(){return this})),t.AsyncIterator=E,t.async=function(e,r,n,a,i){void 0===i&&(i=Promise);var o=new E(h(e,r,n,a),i);return t.isGeneratorFunction(r)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},L(k),f(k,d,"Generator"),f(k,o,(function(){return this})),f(k,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),r=[];for(var n in t)r.push(n);return r.reverse(),function e(){for(;r.length;){var n=r.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},t.values=O,S.prototype={constructor:S,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(j),!t)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var r=this;function a(n,a){return s.type="throw",s.arg=t,r.next=n,a&&(r.method="next",r.arg=e),!!a}for(var i=this.tryEntries.length-1;i>=0;--i){var o=this.tryEntries[i],s=o.completion;if("root"===o.tryLoc)return a("end");if(o.tryLoc<=this.prev){var c=n.call(o,"catchLoc"),u=n.call(o,"finallyLoc");if(c&&u){if(this.prev<o.catchLoc)return a(o.catchLoc,!0);if(this.prev<o.finallyLoc)return a(o.finallyLoc)}else if(c){if(this.prev<o.catchLoc)return a(o.catchLoc,!0)}else{if(!u)throw Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return a(o.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc<=this.prev&&n.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var i=a;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var o=i?i.completion:{};return o.type=e,o.arg=t,i?(this.method="next",this.next=i.finallyLoc,p):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),p},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),j(r),p}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;j(r)}return a}}throw Error("illegal catch attempt")},delegateYield:function(t,r,n){return this.delegate={iterator:O(t),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=e),p}},t}function d(e,t,r,n,a,i,o){try{var s=e[i](o),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function f(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var i=e.apply(t,r);function o(e){d(i,n,a,o,s,"next",e)}function s(e){d(i,n,a,o,s,"throw",e)}o(void 0)}))}}function h(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,p(n.key),n)}}function l(e,t,r){return t=v(t),function(e,t){if(t&&("object"==c(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(e,_()?Reflect.construct(t,r||[],v(e).constructor):t.apply(e,r))}function _(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(_=function(){return!!e})()}function v(e){return v=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},v(e)}function g(e,t){return g=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},g(e,t)}function m(e,t,r){return(t=p(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function p(e){var t=function(e,t){if("object"!=c(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!=c(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==c(t)?t:t+""}var y=function(e){function t(e,r,a,c,d,h,_,v){var g;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),m(g=l(this,t,[e]),"updateInnerImage",function(){var e=f(u().mark((function e(t){var r,a;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(g._innerImage=t,0!==g._mirageSize?g._innerImage.width>g._innerImage.height?(g._width=g._mirageSize,g._height=Math.ceil(g._innerImage.height*g._mirageSize/g._innerImage.width)):(g._height=g._mirageSize,g._width=Math.ceil(g._innerImage.width*g._mirageSize/g._innerImage.height)):(g._width=g._innerImage.width,g._height=g._innerImage.height),!g._byteArray){e.next=8;break}return e.next=5,g._adjustSize();case 5:r=e.sent,n.i.showSize(g._hiddenMetaCanvas.querySelector(".sizeLabel"),r),console.log("Size to be encoded: "+r);case 8:g._innerCanvas.width=g._width,g._innerCanvas.height=g._height,(a=g._innerCanvas.getContext("2d")).drawImage(t,0,0,g._width,g._height),g._innerImageData=a.getImageData(0,0,g._width,g._height),g._sizeLabel.innerHTML="输出图像预计尺寸：".concat(g._width,"x").concat(g._height),3!==g._version&&5!==g._version&&g.convertGray(g._innerImageData),n.i.adjustImageData(g._innerCanvas,g._innerImageData,g._innerContrast,g._innerLuminance),4!==g._version&&5!==g._version&&g._isAddMark&&g.addMark(g._innerCanvas),g._coverImageData&&g.updateCoverImage(g._coverImage);case 18:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),m(g,"_adjustSize",f(u().mark((function e(){var t,r,a,i,o;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=g._width*g._height,e.next=3,g._getRequiredLength(g._version,g._byteArray,g._diff);case 3:if(!((r=e.sent)>t)){e.next=43;break}if(a=r/t,!g._hiddenFile.type.startsWith("image")||g._hiddenFile.type.startsWith("image/gif")){e.next=36;break}return e.next=9,n.i.showMetaCanvas(g._hiddenMetaCanvas,g._hiddenUrl,g._fileExtension,g._hiddenFile.size);case 9:if(!g._isCompress){e.next=33;break}if(!(i=g._hiddenCanvas.getContext("2d").getImageData(0,0,g._hiddenCanvas.width,g._hiddenCanvas.height))){e.next=33;break}return o=g._JpegEncoder.encode(i,g._compressQuality),e.next=15,g._getRequiredLength(g._version,o,g._diff);case 15:if(r=e.sent,!((a=r/t)>1)){e.next=28;break}return a=Math.sqrt(a),e.next=21,n.i.showMetaCanvas(g._hiddenMetaCanvas,g._hiddenUrl,g._fileExtension,g._hiddenFile.size,1/a);case 21:return i=g._hiddenCanvas.getContext("2d").getImageData(0,0,g._hiddenCanvas.width,g._hiddenCanvas.height),o=g._JpegEncoder.encode(i,g._compressQuality),e.next=25,g._getRequiredLength(g._version,o,g._diff);case 25:r=e.sent,(a=r/t)>1&&g._scaleSize(a);case 28:return g._hiddenSizeLabel.innerHTML="隐藏图像尺寸：".concat(g._hiddenCanvas.width,"x").concat(g._hiddenCanvas.height),g._byteArrayCompressed=o,g._fileExtensionCompressed="jpg",g._hiddenMetaCanvas.querySelector(".typeLabel").innerText="里文件类型：image/jpeg",e.abrupt("return",g._byteArrayCompressed.length);case 33:g._hiddenSizeLabel.innerHTML="隐藏图像尺寸：".concat(g._hiddenCanvas.width,"x").concat(g._hiddenCanvas.height),e.next=39;break;case 36:g._hiddenSizeLabel.innerHTML="",g._byteArrayCompressed=null,g._fileExtensionCompressed="";case 39:return g._scaleSize(a),e.abrupt("return",g._byteArray.length);case 43:return g._byteArrayCompressed=null,g._fileExtensionCompressed="",e.abrupt("return",g._byteArray.length);case 46:case"end":return e.stop()}}),e)})))),m(g,"_getRequiredLength",function(){var e=f(u().mark((function e(t,r,n){return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,a){g._encoder.onmessage=function(t){t.data.success?e(t.data.result):a(t.data.error)},g._encoder.onerror=function(e){a(e)},g._encoder.postMessage({mission:"length",version:t,hiddenFile:r,diff:n})})));case 1:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}()),m(g,"_scaleSize",(function(e){e=Math.sqrt(e),g._width=Math.ceil(g._width*e),g._height=Math.ceil(g._height*e)})),m(g,"updateCoverImage",(function(e){if(g._coverImage=e,g._innerImage){var t,r,a,i,o=e.width/e.height;o<g._width/g._height?(t=0,r=Math.ceil((g._height-g._width/o)/2),a=g._width,i=Math.ceil(g._width/o)):(t=Math.ceil((g._width-g._height*o)/2),r=0,a=Math.ceil(g._height*o),i=g._height),g._coverCanvas.width=g._width,g._coverCanvas.height=g._height;var s=g._coverCanvas.getContext("2d");s.drawImage(e,t,r,a,i),g._coverImageData=s.getImageData(0,0,g._width,g._height)}else{g._coverCanvas.width=e.width,g._coverCanvas.height=e.height;var c=g._coverCanvas.getContext("2d");c.drawImage(e,0,0),g._coverImageData=c.getImageData(0,0,e.width,e.height)}5!==g._version&&g.convertGray(g._coverImageData),n.i.adjustImageData(g._coverCanvas,g._coverImageData,g._coverContrast,g._coverLuminance),4!==g._version&&5!==g._version&&g._isAddMark&&g.addMark(g._coverCanvas)})),m(g,"updateHiddenFile",function(){var e=f(u().mark((function e(t){var r,a;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return g._hiddenFile=t,g._byteArrayCompressed=null,g._hiddenUrl&&URL.revokeObjectURL(g._hiddenUrl),g._hiddenUrl=URL.createObjectURL(t),r=t.name,-1!==(a=r.lastIndexOf("."))&&a<r.length-1?(g._fileExtension=r.substring(a+1).toLowerCase(),g._fileExtension.length>10&&(alert("文件拓展名过长，已截断为: "+g._fileExtension.substring(0,10)),g._fileExtension=g._fileExtension.substring(0,10))):g._fileExtension="",e.next=9,n.i.showMetaCanvas(g._hiddenMetaCanvas,g._hiddenUrl,g._fileExtension,t.size);case 9:return t.type.startsWith("image/")&&!t.type.startsWith("image/gif")?g._hiddenSizeLabel.innerHTML="隐藏图像尺寸: ".concat(g._hiddenCanvas.width,"x").concat(g._hiddenCanvas.height):g._hiddenSizeLabel.innerHTML="",e.next=12,g._getHiddenByteArray();case 12:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),m(g,"_getHiddenByteArray",f(u().mark((function e(){return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,t){var r=new FileReader;r.onload=function(){var r=f(u().mark((function r(n){var a;return u().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(r.prev=0,a=n.target.result,g._byteArray=new Uint8Array(a),!g._innerImage){r.next=6;break}return r.next=6,g.updateInnerImage(g._innerImage);case 6:e(),r.next=12;break;case 9:r.prev=9,r.t0=r.catch(0),t(r.t0);case 12:case"end":return r.stop()}}),r,null,[[0,9]])})));return function(e){return r.apply(this,arguments)}}(),r.readAsArrayBuffer(g._hiddenFile)})));case 1:case"end":return e.stop()}}),e)})))),m(g,"process",(function(){if(!g._innerImageData||3!==g._version&&!g._coverImageData||4!==g._version&&5!==g._version&&!g._byteArray)throw new Error("请先选择图像和文件！");var e=g._innerCanvas.getContext("2d").getImageData(0,0,g._width,g._height),t=g._coverCanvas.getContext("2d").getImageData(0,0,g._width,g._height);console.log("Encoding..."),console.log("    Version: "+g._version),console.log("    Output size: "+g._width+"x"+g._height),g._byteArray&&(console.log("    Size to be encoded: "+(g._isCompress&&g._byteArrayCompressed?g._byteArrayCompressed.length:g._byteArray.length)),console.log("    File extension: "+(g._isCompress&&g._fileExtensionCompressed?g._fileExtensionCompressed:g._fileExtension)),console.log("    Difference: "+g._diff)),g._encoder.onmessage=function(e){if(e.data.success){g._outputCanvas.width=g._width,g._outputCanvas.height=g._height;var t=new ImageData(e.data.result,g._width,g._height);g._outputCanvas.getContext("2d").putImageData(t,0,0),g._isOutputCanvasCleared=!1,g._outputData=e.data.result,console.log("Encoding finished"),g._saveLabel.innerText="编码成功！"}else alert("编码失败: "+e.data.error),console.log("Failed to encode:",e.data.error.stack,e.data.error.message),g._saveLabel.innerText="编码失败！"},g._encoder.onerror=function(e){alert("编码失败: "+e.message),console.log("Failed to encode:",e.stack,e.message),g._saveLabel.innerText="编码失败！"},g._saveLabel.innerText="编码中...",g._encoder.postMessage({mission:"encode",version:g._version,innerImageData:e,coverImageData:t,hiddenFile:g._isCompress&&g._byteArrayCompressed?g._byteArrayCompressed:g._byteArray,fileExt:g._isCompress&&g._fileExtensionCompressed?g._fileExtensionCompressed:g._fileExtension,diff:g._diff})})),m(g,"convertGray",(function(e){for(var t=e.data,r=0;r<t.length;r+=4){var n=.299*t[r]+.587*t[r+1]+.114*t[r+2];t[r]=n,t[r+1]=n,t[r+2]=n}})),m(g,"adjustInnerContrast",(function(e){g._innerContrast=e,g._innerImageData&&(n.i.adjustImageData(g._innerCanvas,g._innerImageData,e,g._innerLuminance),g._isAddMark&&g.addMark(g._innerCanvas))})),m(g,"adjustCoverContrast",(function(e){g._coverContrast=e,g._coverImageData&&(n.i.adjustImageData(g._coverCanvas,g._coverImageData,e,g._coverLuminance),g._isAddMark&&g.addMark(g._coverCanvas))})),m(g,"adjustInnerLuminance",(function(e){g._innerLuminance=e,g._innerImageData&&(n.i.adjustImageData(g._innerCanvas,g._innerImageData,g._innerContrast,e),g._isAddMark&&g.addMark(g._innerCanvas))})),m(g,"adjustCoverLuminance",(function(e){g._coverLuminance=e,g._coverImageData&&(n.i.adjustImageData(g._coverCanvas,g._coverImageData,g._coverContrast,e),g._isAddMark&&g.addMark(g._coverCanvas))})),m(g,"saveOutputImage",(function(){if(!g._outputData)throw new Error("请先处理图像！");g._saveLabel.innerText="PNG编码中...",g._PngEncoder.postMessage({width:g._width,height:g._height,data:g._outputData})})),m(g,"setIsAddMark",(function(e){g._isAddMark=e,4!==g._version&&5!==g._version&&(e?(g._innerImageData&&g.addMark(g._innerCanvas),g._coverImageData&&g.addMark(g._coverCanvas)):(g._innerImageData&&n.i.adjustImageData(g._innerCanvas,g._innerImageData,g._innerContrast,g._innerLuminance),g._coverImageData&&n.i.adjustImageData(g._coverCanvas,g._coverImageData,g._coverContrast,g._coverLuminance)))})),m(g,"setMirageSize",function(){var e=f(u().mark((function e(t){return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(g._mirageSize=t,!g._innerImage){e.next=4;break}return e.next=4,g.updateInnerImage(g._innerImage);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),m(g,"setDiff",function(){var e=f(u().mark((function e(t){var r,n=arguments;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=!(n.length>1&&void 0!==n[1])||n[1],g._diff=t,4!==g._version&&5!==g._version){e.next=4;break}return e.abrupt("return");case 4:if(!1!==r){e.next=6;break}return e.abrupt("return");case 6:if(0!==g._version&&3!==g._version||!g._byteArray||!g._innerImage){e.next=9;break}return e.next=9,g.updateInnerImage(g._innerImage);case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),m(g,"setVersion",function(){var e=f(u().mark((function e(t){return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(g._version=t,!g._innerImage){e.next=4;break}return e.next=4,g.updateInnerImage(g._innerImage);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),m(g,"setIsCompress",function(){var e=f(u().mark((function e(t){return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(g._isCompress=t,4===g._version||5===g._version||!g._byteArray||!g._innerImage){e.next=4;break}return e.next=4,g.updateInnerImage(g._innerImage);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),m(g,"clearOutputCanvas",(function(){g._isOutputCanvasCleared||(n.i.clearCanvas(g._outputCanvas),g._isOutputCanvasCleared=!0,g._outputData=null,g._saveLabel.innerText="")})),g._innerImage=null,g._coverImage=null,g._innerImageData=null,g._coverImageData=null,g._innerContrast=e.contrast_inner,g._coverContrast=e.contrast_cover,g._innerLuminance=e.luminance_inner,g._coverLuminance=e.luminance_cover,g._mirageSize=e.mirage_size,g._isCompress=e.encode_compress,g._compressQuality=e.encode_compress_quality,g._version=e.version,g._diff=e["version_".concat(g._version)].difference,g._hiddenFile=null,g._fileExtension="",g._fileExtensionCompressed="",g._byteArray=null,g._byteArrayCompressed=null,g._outputData=null,g._innerCanvas=document.getElementById(r),g._coverCanvas=document.getElementById(a),g._hiddenMetaCanvas=document.getElementById(c),g._hiddenCanvas=g._hiddenMetaCanvas.querySelector("canvas"),g._outputCanvas=document.getElementById(d),g._sizeLabel=document.getElementById(h),g._hiddenSizeLabel=document.getElementById(_),g._saveLabel=document.getElementById(v),g._isAddMark=e.add_mark,g._markRatio=e.mark_ratio,g._JpegEncoder=new i(g._compressQuality),g._PngEncoder=new o,g._PngEncoder.onmessage=function(e){if(e.data.success){var t=document.createElement("a");t.href=e.data.result.url,t.download=e.data.result.fileName,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(t.href),g._saveLabel.innerText="保存成功！"+e.data.result.fileName}else alert("编码失败: "+e.data.error),console.log("Failed to encode:",e.data.error.stack,e.data.error.message),g._saveLabel.innerText="保存失败！"},g._PngEncoder.onerror=function(e){alert("编码失败: "+e.message),console.log("Failed to encode:",e.stack,e.message)},g._encoder=new s,g._encoder.onmessage=function(e){if(!e.data.success)return alert("编码器初始化失败: "+e.data.error),void console.log("Failed to init encoder:",e.data.error.stack,e.data.error.message)},g._encoder.onerror=function(e){alert("编码任务失败: "+e.message),console.log("Failed to encode:",e.stack,e.message)},g._encoder.postMessage({mission:"init",defaultArguments:e}),g}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&g(e,t)}(t,e),r=t,(a=[{key:"addMark",value:function(e,t){if(4!==this._version&&5!==this._version){if(!t){if(!applicationState.markImage)return;t=applicationState.markImage}var r=e.width*this._markRatio,n=e.height*this._markRatio,a=r/n,i=t.width/t.height;a>i?r=n*i:n=r/i,e.getContext("2d").drawImage(t,0,0,r,n)}}}])&&h(r.prototype,a),c&&h(r,c),Object.defineProperty(r,"prototype",{writable:!1}),r;var r,a,c}(n.i)}}]);