<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">

<head>
    <script>
        // global namespaces
        var applicationState = applicationState || {};
        var errorHandling = errorHandling || {};
        errorHandling.scriptsLoaded = errorHandling.scriptsLoaded || {};
        var CloakProcessor = CloakProcessor || {};
    </script>
    <script>
        applicationState.version = '1.0.0';
        // version check
        (() => {
            console.log('target version:', applicationState.version);
            console.log('current version:', localStorage.getItem('version'));
            const previousVersion = localStorage.getItem('version');
            if (!previousVersion || previousVersion !== applicationState.version) {
                console.log('new version detected, clearing cache');
                localStorage.clear();
                localStorage.setItem('version', applicationState.version);
                location.reload(true);
            }
        })();
        // cache busting, just in case
        var scripts = document.querySelectorAll('script[data-version]');
        scripts.forEach(function (script) {
            var src = script.getAttribute('src');
            if (src) {
                script.setAttribute('src', src + '?v=' + applicationState.version);
            }
        });
        var links = document.querySelectorAll('link[rel="stylesheet"]');
        links.forEach(function (link) {
            var href = link.getAttribute('href');
            if (href) {
                link.setAttribute('href', href + '?v=' + applicationState.version);
            }
        });
    </script>

    <script>
        function applyTheme(tarTheme) {
            if (tarTheme === undefined || typeof tarTheme !== 'string') {
                const prefersDarkScheme = window.matchMedia("(prefers-color-scheme: dark)").matches;
                tarTheme = prefersDarkScheme ? "dark" : "light";
            }
            document.documentElement.setAttribute("data-theme", tarTheme);
            const isDarkmodeCheckbox = document.getElementById('isDarkmodeCheckbox');
            if (isDarkmodeCheckbox) {
                isDarkmodeCheckbox.checked = tarTheme === 'dark';
            } else {
                document.addEventListener('DOMContentLoaded', function () {
                    const isDarkmodeCheckbox = document.getElementById('isDarkmodeCheckbox');
                    isDarkmodeCheckbox.checked = tarTheme === 'dark';
                });
            }
        }
        applyTheme();
        window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", applyTheme);
    </script>

    <script>
        // test if all scripts are loaded
        document.addEventListener('DOMContentLoaded', function () {
            const requiredScripts = [
                'DefaultArguments',
                'CloakUniversal',
                'CloakDecoder',
                'CloakEncoder',
                'DecodeListeners',
                'EncodeListeners',
                'UniversalListeners',
                'init'
            ];
            for (let i = 0; i < requiredScripts.length; i++) {
                if (!errorHandling.scriptsLoaded[requiredScripts[i]]) {
                    console.error('Script not loaded:', requiredScripts[i]);
                    alert('脚本' + requiredScripts[i] + '未能正确加载，请清空页面缓存后刷新重试。');
                    return;
                }
            }
            console.log('All scripts loaded successfully.');
        });
    </script>

    <link rel="icon" href="resources/neko.ico" type="image/x-icon">

    <title>${UNKNOWN}坦克工厂</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <link rel="stylesheet" type="text/css" href="css/classes.css">
    <link rel="stylesheet" type="text/css" href="css/switch.css">
    <script id="jsonPath" data-json-path="DefaultArguments.json" defer></script>
    <script type="module" src="scripts/DefaultArguments.js" defer data-version></script>
    <script type="module" src="scripts/processors/CloakUniversal.js" defer data-version></script>
    <script type="module" src="scripts/processors/CloakDecoder.js" defer data-version></script>
    <script type="module" src="scripts/processors/CloakEncoder.js" defer data-version></script>
    <script src="scripts/listeners/DecodeListeners.js" defer data-version></script>
    <script src="scripts/listeners/EncodeListeners.js" defer data-version></script>
    <script src="scripts/listeners/UniversalListeners.js" defer data-version></script>
    <script type="module" src="scripts/init.js" defer data-version></script>
</head>

<body class="flexColumn marginTopHigh displayFlex justifyCenter alignCenter marginTopHigh backgroundPrimary frontColor">

    <h1 class="title">这是一个标题</h1>

    <div class="switchContainer">
        <p>切换明/暗主题</p>
        <label class="switch" id="isDarkmodeSwitch">
            <input type="checkbox" id="isDarkmodeCheckbox" title="switch from themes">
            <span class="switchSlider"></span>
        </label>
    </div>

    <div class="PageContainer displayFlex justifyCenter alignCenter flexColumn refWidthHigh paddingHigh">

        <div class="TitleContainer displayFlex justifySpaceBetween alignCenter flexRow gapLow refWidthFull">
            <button
                class="PageSwitchButton paddingHigh refWidthFull borderRadiusOnlyTop fontMedium transformSecondary frontColor borderSolidNone"
                id="decodeButton"><b>显形</b></button>
            <button
                class="PageSwitchButton paddingHigh refWidthFull borderRadiusOnlyTop fontMedium transformSecondary frontColor borderSolidNone"
                id="encodeButton"><b>制作</b></button>
        </div>

        <div class="DisplayArea frontColor borderRadiusOnlyBottom justifyCenter alignCenter flexColumn refWidthFull backgroundSecondary"
            id="decodePage">
            <div id="decodeImageSelect" class="displayFlex flexColumn alignCenter marginTopHigh ">
                <div id="decodeFileInput" class="displayFlex alignCenter">
                    <label for="decodeImageFileInput"
                        class="fileInputLabel marginLeftLow inputReact transformSize">选择图片文件</label>
                    <input type="file" id="decodeImageFileInput" accept="image/*">
                </div>
                <div id="decodeUrlInput" class="displayFlex alignCenter marginTopMedium">
                    <label for="decodeImageUrlInput" class="marginRightLow">或:</label>
                    <input type="text" id="decodeImageUrlInput" class="inputReact marginRightLow" placeholder="输入图片URL">
                    <button id="decodeLoadImageButton" class="inputReact transformSize">加载图片</button>
                </div>
                <div id="decodePasteInput" class="marginTopMedium">
                    或从剪贴板粘贴图片 (ctrl+v),
                </div>
                <div id="decodePasteButton" class="flexRow alignCenter marginTopMedium">
                    <label for="decodePasteButtonInput">或从剪贴板</label>
                    <button id="decodePasteButtonInput" class="inputReact marginLeftLow transformSize">粘贴图片</button>
                </div>
                <div id="decodeDragInputHint" class="marginTopMedium">
                    或直接将图片拖进窗口。
                </div>
            </div>

            <canvas id="decodeInputCanvas" class="marginTopHigh"></canvas>

            <!-- <button id="decodeProcessButton" class="inputReact marginTopHigh transformSize">开始解码</button> -->

            <canvas id="decodeOutputCanvas" class="marginTopHigh"></canvas>

            <button id="decodeSaveButton" class="inputReact marginTopHigh marginBottomHigh transformSize">保存结果</button>

        </div>

        <div class="DisplayArea frontColor borderRadiusOnlyBottom justifyCenter alignCenter flexColumn refWidthFull backgroundSecondary"
            id="encodePage">
            <div class="displayFlex flexRow justifyCenter alignCenter marginTopHigh refWidthHigh">
                <div class="encodeFileInput displayFlex flexColumn justifyCenter alignCenter refWidthHalf">
                    <label for="innerSourceFileInput" class="fileInputLabel inputReact transformSize">1. 选择里图文件</label>
                    <input type="file" id="innerSourceFileInput" accept="image/*">
                    <label for="innerSourceFileInput" class="encodeDrag marginTopMedium fontSmall">或直接拖动至下方画布</label>
                    <canvas id="innerCanvas" class="refWidthHigh marginTopMedium"></canvas>
                    <slider
                        class="encodeSlider refWidthHigh displayFlex flexColumn alignCenter justifyCenter marginTopMedium">
                        <label for="innerContrastRange" class="encodeSliderTitle">3. 里图对比度: </label>
                        <input type="range" id="innerContrastRange" class="refWidthHigh marginTopLow" min="0" max="100">
                        <button id="innerResetContrastButton" class="inputReact marginTopLow">重置对比度</button>
                    </slider>
                </div>

                <div class="encodeFileInput displayFlex flexColumn justifyCenter alignCenter refWidthHalf">
                    <label for="coverSourceFileInput" class="fileInputLabel inputReact transformSize">2. 选择表图文件</label>
                    <input type="file" id="coverSourceFileInput" accept="image/*">
                    <label for="coverSourceFileInput" class="encodeDrag marginTopMedium fontSmall">或直接拖动至下方画布</label>
                    <canvas id="coverCanvas" class="refWidthHigh marginTopMedium"></canvas>
                    <slider
                        class="encodeSlider  refWidthHigh displayFlex flexColumn alignCenter justifyCenter marginTopMedium">
                        <label for="coverContrastRange" class="encodeSliderTitle">4. 表图对比度: </label>
                        <input type="range" id="coverContrastRange" class="refWidthHigh marginTopLow" min="0" max="100">
                        <button id="coverResetContrastButton" class="inputReact marginTopLow">重置对比度</button>
                    </slider>
                </div>
            </div>

            <!-- <label for="encodeSizeLimit" class="marginTopMedium">5. 指定输出图像最大长或宽:</label>
            <input id="encodeSizeLimit" type="number" class="inputReact marginTopLow"></input>
            <label for="encodeSizeLimit" class="fontSmall marginTopLow">(0即为不限制)</label> -->

            <label for="hiddenSourceFileInput" class="fileInputLabel inputReact transformSize marginTopMedium">6.
                选择隐写文件</label>
            <input type="file" id="hiddenSourceFileInput">
            <label for="hiddenSourceFileInput" class="encodeDrag marginTopMedium fontSmall">或直接拖动至下方画布</label>
            <canvas id="hiddenCanvas" class="marginTopMedium"></canvas>
            <div id="encodeOutputSize" class="marginTopMedium"></div>
            <div class="marginTopLow fontSmall">(若尺寸过大可适当降低隐写文件的大小)</div>

            <button id="encodeProcessButton" class="inputReact marginTopMedium transformSize">开始编码</button>

            <canvas id="encodeOutputCanvas" class="marginTopMedium"></canvas>

            <button id="encodeSaveButton"
                class="inputReact marginTopMedium marginBottomHigh transformSize">保存结果</button>

        </div>

        <div id="pageBelow">
            <p id="versionInfo">version: <b>UNKNOWN</b></p>

            <p id="refreshHint">
                如发现有功能不正常可手动清理浏览器缓存后刷新
            </p>

            <div class="link" , id="bugReportLink">
                <a href="https://github.com/Uyanide/Mirage_Decode/issues/new" target="_blank">Bug反馈</a>
            </div>

            <div class="link" , id="profileLink">
                <a href="https://github.com/Uyanide" target="_blank">Github - Uyanide (我)</a>
            </div>

            <div class="link" , id="repoLink">
                <a href="https://github.com/Uyanide/Mirage_Decode/tree/main" target="_blank">Github -
                    Mirage_Decode (本项目仓库)</a>
            </div>

            <div class="link" , id="repoLink">
                <a href="https://github.com/Uyanide/Mirage_Decode?tab=readme-ov-file#qa" target="_blank">常见问题Q&A</a>
            </div>

            <div id="privacyButton">
                <button id="togglePrivacyPolicy">显示使用须知</button>
            </div>

            <div id="privacyPolicy">
                <p>本网站仅供个人学习交流使用，禁止一切非法用途，否则一切后果由使用者自行承担。</p>
                <p>本网站使用Google Analytics记录访问者的行为。通过使用本网站，您同意数据按照Google Analytics的条款和隐私政策进行处理。更多信息，请访问:<a
                        href="https://policies.google.com/privacy" target="_blank">Google
                        Analytics的隐私政策</a>。</p>
            </div>

            <div id="versionRecordButton">
                <button id="toggleVersionRecord">显示主要更新记录</button>
            </div>

            <div id="versionRecord">
                <table id="versionRecordTable">
                    <tbody>
                        <tr>
                            <td>1.0</td>
                            <td>初始版本。
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
</body>

</html>